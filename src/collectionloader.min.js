PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},loadCollection:function(n){if(!n instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection.";}});PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(n,t){this.cxmlUriNoProxy=n;this.cxmlUri=t?t+n:n},loadCollection:function(n){var n=n,t;this._super(n);n.baseNoProxy=this.cxmlUriNoProxy;n.base=this.cxmlUri;t=this;this.cxmlUri.endsWith(".zip")?jBinary.loadData(this.cxmlUri).then(function(i){var u=new JSZip,r;u.load(i);r=u.file(/.cxml/)[0].asText();t.loadXML(n,$.parseXML(r.substring(r.indexOf(">")+1)))}):$.ajax({type:"GET",url:this.cxmlUri,dataType:"xml",success:function(n){return function(i){t.loadXML(n,i)}}(n),error:function(n,t,i){var r,u;$(".pv-loading").remove();r="Error loading CXML Collection<br><br>";r+="URL        : "+this.url+"<br>";r+="Status : "+n.status+" "+i+"<br>";r+="Details    : "+n.responseText+"<br>";r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+r+"<\/p><\/div><\/div>");u=setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})},loadXML:function(n,t){var l=$(t).find("Collection")[0],et=0,r="P",ot,o,ht,it,s,b,u,k,rt,ut,a,e,f,d,h,g,ct,p,nt,at,c,tt,vt,w,y,i,ft;if(l==undefined){$(".pv-loading").remove();b="Error parsing CXML Collection<br>";b+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-parse-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+b+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-parse-error","_self")},1e3);throw"Error parsing CXML Collection";}for(u=0;u<l.attributes.length;u++)if(l.attributes[u].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){r=l.attributes[u].localName!=undefined?l.attributes[u].localName:l.attributes[u].baseName;break}for(n.name=$(l).attr("Name"),n.brandImage=$(l).attr(r+":BrandImage")!=undefined?$(l).attr(r+":BrandImage"):"",ot=$(t).find("FacetCategory"),y=r,u=0;u<ot.length;u++){for(o=$(ot[u]),i=0;i<o[0].attributes.length;i++)if(o[0].attributes[i].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){r=o[0].attributes[i].localName!=undefined?o[0].attributes[i].localName:o[0].attributes[i].baseName;break}var lt=new PivotViewer.Models.Category(o.attr("Name"),o.attr("Type"),o.attr(r+":IsFilterVisible")!=undefined?o.attr(r+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0),v=o.find(r+"\\:SortOrder"),st=v.find(r+"\\:SortValue");if(v.length==0&&(v=o.find("SortOrder"),st=v.find("SortValue")),v.length==1){for(ht=new PivotViewer.Models.CategorySort(v.attr("Name")),i=0;i<st.length;i++)ht.sortValues.push($(st[i]).attr("Value"));lt.customSort=ht}n.categories.push(lt);r=y}if(it=$(t).find("Items"),it.length==1)if(s=$(it[0]).find("Item"),n.imageBase=$(it[0]).attr("ImgBase"),s.length==0)$(".pv-loading").remove(),b="There are no items in the CXML Collection<br><br>",$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+b+"<\/p><\/div><\/div>"),setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3);else for(u=0;u<s.length;u++){for(k=new PivotViewer.Models.Item($(s[u]).attr("Img").replace("#",""),$(s[u]).attr("Id"),$(s[u]).attr("Href"),$(s[u]).attr("Name")),rt=$(s[u]).find("Description"),rt.length==1&&rt[0].childNodes.length&&(k.description=PivotViewer.Utils.htmlSpecialChars(rt[0].childNodes[0].nodeValue)),ut=$(s[u]).find("Facet"),i=0;i<ut.length;i++){for(a=new PivotViewer.Models.Facet($(ut[i]).attr("Name")),e=$(ut[i]).children(),f=0;f<e.length;f++)e[f].nodeType==1&&(d=$.trim($(e[f]).attr("Value")),d==null||d==""?e[f].nodeName=="Link"?$(e[f]).attr("Href")==""||$(e[f]).attr("Href")==null?(h=new PivotViewer.Models.FacetValue(PivotViewer.Utils.htmlSpecialChars("(empty Link)")),a.addValue(h)):$(e[f]).attr("Name")==""||$(e[f]).attr("Name")==null?(h=new PivotViewer.Models.FacetValue("(unnamed Link)"),h.href=$(e[f]).attr("Href"),a.addValue(h)):(h=new PivotViewer.Models.FacetValue($(e[f]).attr("Name")),h.href=$(e[f]).attr("Href"),a.addValue(h)):(h=new PivotViewer.Models.FacetValue(PivotViewer.Utils.htmlSpecialChars("(empty "+e[f].nodeName+")")),a.addValue(h)):e[f].nodeName=="Number"?a.addValue(new PivotViewer.Models.FacetValue(parseFloat(d))):a.addValue(new PivotViewer.Models.FacetValue(PivotViewer.Utils.htmlSpecialChars(d))));k.facets.push(a)}if(g=$(s[u]).find("Extension"),g.length==1){for(y=r,i=0;i<g[0].childNodes.length;i++)if(r=g[0].childNodes[i].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"),r)break;if(ct=$(g[0]).find(r+"\\:Related, Related"),ct.length==1){for(p=$(ct[0]).find(r+"\\:Link, Link"),nt=0;nt<p.length;nt++)at=$(p[nt]).attr("Name"),c=$(p[nt]).attr("Href"),c.indexOf(".cxml")==-1&&c.indexOf("pivot.vsp")>=0?(tt=$.url(this.url),c=tt.attr("protocol")+"://"+tt.attr("authority")+tt.attr("directory")+c):c.indexOf(".cxml")==-1&&c.indexOf("sparql")>=0&&(tt=$.url(this.url),c=location.origin+location.pathname+"?url="+c),vt=new PivotViewer.Models.ItemLink(at,c),k.links.push(vt);p.length>et&&(et=p.length)}r=y}n.items.push(k)}if(n.maxRelatedLinks=et,w=$(t).find("Extension"),w.length>1)for(x=0;x<w.length;x++){for(y=r,i=0;i<w[x].childNodes.length;i++)if(r=w[0].childNodes[i].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"),r)break;if(ft=$(w[x]).find(r+"\\:Copyright, Copyright"),ft.length>0){n.copyrightName=$(ft[0]).attr("Name");n.copyrightHref=$(ft[0]).attr("Href");break}r=y}s.length>0&&$.publish("/PivotViewer/Models/Collection/Loaded",null)},loadColumn:function(){},getRow:function(n){return PivotCollection.getItemById(n).facets}});
