PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.scale=1;this._super();this.dontZoom=!1;this.numMissing=0;var n=this;$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){var u,i;if(n.isActive){if(n.dontZoom){n.dontZoom=!1;return}var r=n.scale,e=n.currentWidth,o=n.currentHeight,f=t.scale!=undefined?0:1e3;if(t.scale!=undefined?t.scale>=1?n.scale+=t.scale-1:(n.scale-=t.scale,n.scale=n.scale<1?1:n.scale):t.delta!=undefined&&(n.scale=t.delta==0?1:n.scale+t.delta),isNaN(n.scale)&&(n.scale=1),u=(n.width-n.offsetX)*n.scale,u<n.width||n.scale==1?(n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY,n.currentWidth=n.width,n.currentHeight=n.height,n.scale=1,n.dontZoom=!0,PV.zoom(0),n.recalibrateUISettings()):(n.currentOffsetX=t.x-(t.x-n.currentOffsetX)/r*n.scale,n.currentOffsetY=t.y-(t.y-n.currentOffsetY)/r*n.scale,n.currentWidth=u,n.currentHeight=(n.height-n.offsetY)*n.scale,n.recalibrateUISettings()),n.setTilePositions(n.rowscols,n.filterList,n.currentOffsetX,n.currentOffsetY,!0,!0,f),n.scale==1&&r!=1){for(i=0;i<n.tiles.length;i++)n.tiles[i].setSelected(!1);n.selected=null;$.publish("/PivotViewer/Views/Item/Selected",[{item:n.selected,bkt:0}])}}})},resetUISettings:function(){this.rowscols=this.calculateDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing)},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing,this.rowscols)},setup:function(n,t,i,r,u){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.maxRatio=u;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY},activate:function(){var n=this,i,u,f,t,r;if(Modernizr.canvas){for(this._super(),i=0;i<this.tiles.length;i++)this.tiles[i]._locations=[this.tiles[i]._locations[0]];for(t=0;t<this.tiles.length;t++)this.tiles[t].selectedLoc=0;if(u=0,f=$(".pv-toolbarpanel-zoomslider").slider("option","value"),f>0){for(this.selected=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.zoom(0),this.resetUISettings(),t=0;t<this.filterList.length;t++)r=this.filterList[t],r.origwidth=this.rowscols.TileHeight/TileController._imageController.getRatio(r.item.img),r.origheight=this.rowscols.TileHeight;this.setTilePositions(this.rowscols,this.tiles,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3);u=1e3}setTimeout(function(){for(var t,r,u,f,i=0;i<n.tiles.length;i++)(t=n.tiles[i],t._locations[0].startx=t._locations[0].x,t._locations[0].starty=t._locations[0].y,t.startwidth=t.width,t.startheight=t.height,t.filtered&&(Settings.showMissing||!t.missing))||(t.start=PivotViewer.Utils.now(),t.end=t.start+1e3,r=Math.atan2(t._locations[0].y-n.currentHeight/2,t._locations[0].x-n.currentWidth/2),t._locations[0].destinationx=n.currentWidth*Math.cos(r)+n.currentWidth/2,t._locations[0].destinationy=n.currentHeight*Math.sin(r)+n.currentHeight/2,t.destinationwidth=1,t.destinationheight=1);for(n.maxRatio=TileController._imageController.getRatio(n.tiles[0].item.img),i=0;i<n.filterList.length;i++)u=TileController._imageController.getRatio(n.filterList[i].item.img),u<n.maxRatio&&(n.maxRatio=u);f=n.filterList.length==n.tiles.length?0:500;setTimeout(function(){var t,i;if(n.numMissing=0,!Settings.showMissing)for(t=0;t<n.filterList.length;t++)n.filterList[t].missing&&n.numMissing++;for(n.resetUISettings(),t=0;t<n.tiles.length;t++)i=n.tiles[t],i.origwidth=n.rowscols.TileHeight/TileController._imageController.getRatio(i.item.img),i.origheight=n.rowscols.TileHeight;n.setTilePositions(n.rowscols,n.filterList,n.offsetX,n.offsetY,!1,!1,1e3)},f)},u)}},getButtonImage:function(){return"images/GridView.png"},getButtonImageSelected:function(){return"images/GridViewSelected.png"},getViewName:function(){return"Grid View"},setTilePositions:function(n,t,i,r,u,f,e){var l=f&&this.rowscols?this.rowscols.Columns:n.Columns,s,c,h,o;for(f||(this.rowscols=n),s=0,c=0,h=0;h<t.length;h++)(o=t[h],Settings.showMissing||!o.missing)&&(u&&(o._locations[0].startx=o._locations[0].x,o._locations[0].starty=o._locations[0].y,o.startwidth=o.width,o.startheight=o.height),o.destinationwidth=n.TileMaxWidth,o.destinationheight=n.TileHeight,o._locations[0].destinationx=s*n.TileMaxWidth+i,o._locations[0].destinationy=c*n.TileHeight+r,o.start=PivotViewer.Utils.now(),o.end=o.start+e,s==l-1?(s=0,c++):s++)},centerOnTile:function(n){var r=Math.round((n._locations[0].x-this.currentOffsetX)/n.width),u=Math.round((n._locations[0].y-this.currentOffsetY)/n.height),t=n.context.canvas.height,i=n.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());origProportion=n.height/t>n.height/TileController._imageController.getRatio(n.item.img)/i?n.origheight/t:n.origwidth/i;this.selected==null&&PV.zoom(Math.round(.75/origProportion*2));this.currentOffsetX=this.rowscols.TileMaxWidth*-r+this.width/2-this.rowscols.TileMaxWidth/2;this.currentOffsetY=this.rowscols.TileHeight*-u+this.height/2-this.rowscols.TileHeight/2;this.setTilePositions(this.rowscols,this.filterList,this.currentOffsetX,this.currentOffsetY,!0,!0,1e3)},handleClick:function(n){var t=this._super(n);t!=null&&t.setSelected(!0);t!=null&&this.selected!=t?this.centerOnTile(t):(this.selected=t=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.zoom(0));$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])}});