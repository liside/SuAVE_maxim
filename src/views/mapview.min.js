PivotViewer.Utils.loadScript("lib/wicket/wicket.min.js"),PivotViewer.Utils.loadCSS("lib/leaflet/leaflet.css"),PivotViewer.Utils.loadScript("lib/leaflet/leaflet.js"),PivotViewer.Views.MapView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super(),this.locCache=[],this.map=null,this.markers=[],this.overlay,this.overlayBaseImageUrl=null,this.itemsToGeocode=[],this.startGeocode,this.geocodeZero,this.applyBookmark=!1,this.mapService=null,this.APIKey=null,this.geocodeService=null,this.geometryValue=null,this.areaValues=[],this.areaObj,this.buckets=[],this.icons=[],this.iconsSelected=[],this.selectedMarker=null,this.selectedBucket=-1;var e=this;$.subscribe("/PivotViewer/Views/Item/Selected",function(t){e.isActive&&e.selectMarker(t.item)})},setup:function(e,t,i,a,s){this.width=e,this.height=t,this.offsetX=i,this.offsetY=a,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,Modernizr.localstorage?this.localStorage=!0:this.localStorage=!1,window.mapView=this},apiLoaded:function(){var e=this;this.map=new google.maps.Map(document.getElementById("pv-map-canvas")),google.maps.event.addListener(this.map,"zoom_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null),e.getOverlay()}),google.maps.event.addListener(this.map,"center_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null),e.getOverlay()}),this.icons=["lib/leaflet/images/Red.png","lib/leaflet/images/Yellow.png","lib/leaflet/images/DarkGreen.png","lib/leaflet/images/Blue.png","lib/leaflet/images/Purple.png","lib/leaflet/images/Orange.png","lib/leaflet/images/Pink.png","lib/leaflet/images/Sky.png","lib/leaflet/images/Lime.png","lib/leaflet/images/Gold.png","lib/leaflet/images/Green.png"],this.iconsSelected=["lib/leaflet/images/RedDot.png","lib/leaflet/images/YellowDot.png","lib/leaflet/images/DarkGreenDot.png","lib/leaflet/images/BlueDot.png","lib/leaflet/images/PurpleDot.png","lib/leaflet/images/OrangeDot.png","lib/leaflet/images/PinkDot.png","lib/leaflet/images/SkyDot.png","lib/leaflet/images/LimeDot.png","lib/leaflet/images/GoldDot.png","lib/leaflet/images/GreenDot.png"],this.clearMarkers=function(){for(var e=0;e<this.tiles.length;e++){var t=this.tiles[e].marker;void 0!=t&&t.setMap(null)}},this.selectMarker=function(t){var i=e.getBucketNumber(t);if(t.marker==e.selectedMarker)t.marker.setIcon(e.icons[i]),e.selected=null,e.selectedMarker.setZIndex(0),e.selectedMarker=null,e.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn();else{t.marker.setIcon(e.iconsSelected[i]),t.marker.setZIndex(1e9),e.selected=t,null!=e.selectedMarker&&(e.selectedMarker.setZIndex(0),e.selectedMarker.setIcon(e.icons[e.selectedBucket])),e.selectedMarker=t.marker,e.selectedBucket=i,e.map.panTo(t.loc),$(".pv-toolbarpanel-info").empty();var a="<img style='height:15px;width:auto' src='"+e.icons[i]+"'></img>";a+=e.buckets[i].startRange==e.buckets[i].endRange?e.buckets[i].startRange:e.buckets[i].startRange+" to "+e.buckets[i].endRange,$(".pv-toolbarpanel-info").append(a),$(".pv-altinfopanel").hide()}},this.newMarker=function(e){e.marker=new google.maps.Marker({position:e.loc,map:this.map,title:e.item.name}),e.marker.setIcon(this.icons[this.buckets.ids[e.item.id]]),google.maps.event.addListener(e.marker,"click",function(e){return function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:e}])}}(e))},this.refitBounds=function(){var e=new google.maps.LatLngBounds;for(i=0;i<this.filterList.length;i++){var t=this.filterList[i];void 0==t.loc||!Settings.showMissing&&t.missing||e.extend(t.marker.position)}this.map.fitBounds(e)},this.getOverlay=function(){var e=this.map.getBounds();if(e){var t=e.getSouthWest(),i=e.getNorthEast(),a=$("#pv-map-canvas").width(),s=$("#pv-map-canvas").height();if(null!=this.overlayBaseImageUrl){this.overlay&&this.overlay.setMap(null);var n=this.overlayBaseImageUrl+"&bbox="+t.lng()+","+t.lat()+","+i.lng()+","+i.lat()+"&width="+a+"&height="+s;this.overlay=new google.maps.GroundOverlay(n,e,{opacity:.4}),this.overlay.setMap(this.map)}}},$(".pv-mainpanel").append("<div class='pv-altinfopanel' id='pv-altinfopanel'></div>"),$(".pv-altinfopanel").css("left",$(".pv-mainpanel").offset().left+$(".pv-mainpanel").width()-205+"px").css("height",$(window).height()-$(".pv-toolbarpanel").height()-58+"px"),this.activate()},setOptions:function(e){if($(".pv-viewpanel").append("<div class='pv-mapview-canvas' id='pv-map-canvas'></div>"),void 0==e.MapService||"openstreetmap"!=e.MapService.toLowerCase())this.APIKey=void 0!=e.GoogleAPIKey?e.GoogleAPIKey:"AIzaSyAnPWLPKMYKQZa2g1p11d_vllwwT7CFdQg",this.mapService="google",PivotViewer.Utils.loadScript("lib/wicket/wicket-gmap3.min.js"),"Google"==e.GeocodeService?this.geocodeService="Google":GeocodeService="Nominatim";else{this.mapService="openstreetmap",this.geocodeService="Nominatim",PivotViewer.Utils.loadScript("lib/wicket/wicket-leaflet.min.js"),this.map=new L.Map(document.getElementById("pv-map-canvas"));var t="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",a="Map data Â© OpenStreetMap contributors";this.osm=new L.TileLayer(t,{attribution:a}),this.map.addLayer(this.osm),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Red.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Yellow.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreen.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Blue.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Purple.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Orange.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Pink.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Sky.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Lime.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Gold.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Green.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/RedDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/YellowDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreenDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/BlueDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PurpleDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/OrangeDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PinkDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/SkyDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/LimeDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GoldDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GreenDot.png"}}));var s=this;this.map.on("zoomend",function(e){$.publish("/PivotViewer/Views/Item/Updated",null),s.getOverlay()}),this.map.on("moveend",function(e){$.publish("/PivotViewer/Views/Item/Updated",null),s.getOverlay()}),this.clearMarkers=function(){for(var e=0;e<this.tiles.length;e++){var t=this.tiles[e].marker;void 0!=t&&this.map.removeLayer(t)}},this.selectMarker=function(e){var t=s.getBucketNumber(e);if(e.marker==s.selectedMarker)e.marker.setIcon(new s.icons[t]),s.selected=null,s.selectedMarker.setZIndexOffset(0),s.selectedMarker=null,s.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn();else{e.marker.setIcon(new s.iconsSelected[t]),e.marker.setZIndexOffset(1e9),s.selected=e,null!=s.selectedMarker&&(s.selectedMarker.setIcon(new s.icons[s.selectedBucket]),s.selectedMarker.setZIndexOffset(0)),s.selectedMarker=e.marker,s.selectedBucket=t,s.map.panTo(e.loc),$(".pv-toolbarpanel-info").empty();var i="<img style='height:15px;width:auto' src='"+e.marker._icon.src+"'></img>";i+=s.buckets[t].startRange==s.buckets[t].endRange?s.buckets[t].startRange:s.buckets[t].startRange+" to "+s.buckets[t].endRange,$(".pv-toolbarpanel-info").append(i),$(".pv-altinfopanel").hide()}},this.newMarker=function(e){return e.marker=new L.Marker(e.loc,{title:e.item.name}),this.map.addLayer(e.marker),e.marker.setIcon(new this.icons[this.buckets.ids[e.item.id]]),e.marker.on("click",function(e){return function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:e}])}}(e)),marker},this.refitBounds=function(){var e=[];for(i=0;i<this.filterList.length;i++){var t=this.filterList[i];void 0!=t.marker&&e.push(t.marker.getLatLng())}var a=new L.LatLngBounds(e);this.map.fitBounds(a)},this.getOverlay=function(){var e=this.map.getBounds(),t=e.getWest(),i=e.getEast(),a=e.getNorth(),s=e.getSouth(),n=this.map.getSize(),l=n.x,o=n.y;if(null!=this.overlayBaseImageUrl){this.overlay&&this.map.hasLayer(this.overlay)&&this.map.removeLayer(this.overlay);var r=this.overlayBaseImageUrl+"&bbox="+t+","+s+","+i+","+a+"&width="+l+"&height="+o;this.overlay=new L.imageOverlay(r,e,{opacity:.4}),this.overlay.addTo(this.map)}}}void 0!=e.MapOverlay&&(this.overlayBaseImageUrl=e.MapOverlay)},activate:function(){Modernizr.canvas&&("google"==this.mapService&&null==this.map?PivotViewer.Utils.loadScript("https://maps.googleapis.com/maps/api/js?key="+this.APIKey+"&sensor=false&callback=mapView.apiLoaded"):this._super(),$(".pv-toolbarpanel-info").fadeIn(),$(".pv-altinfopanel").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").hide(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-mapview-canvas").fadeIn(),$(".pv-toolbarpanel-sort").fadeIn())},deactivate:function(){this._super(),$(".pv-altinfopanel").fadeOut(),$(".pv-toolbarpanel-info").fadeOut(),$(".pv-mapview-canvas").fadeOut(),$(".pv-toolbarpanel-sort").fadeOut()},getBucketNumber:function(e){var t=this.buckets.ids[e.item.id];return void 0!=t?t:-1},bucketize:function(e,t,i){if(category=PivotCollection.getCategoryByName(i),void 0==t[0].item.getFacetByName(i))return[{startRange:"(no info)",endRange:"(no info)",tiles:[t[0]],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}];for(var a=t[0].item.getFacetByName(i).values[0].value,s=t.length-1;s>0&&void 0==t[s].item.getFacetByName(i);s--);var n=t[s].item.getFacetByName(i).values[0].value;return category.isDateTime()?(a=new Date(a),n=new Date(n),n.getFullYear()-a.getFullYear()+a.getFullYear()%10>9?PivotViewer.Utils.getBuckets(t,i,function(e){var t=new Date(e.value).getFullYear();return t-t%10},function(e){var t=new Date(e.value).getFullYear();return t-t%10+"s"}):n.getFullYear()>a.getFullYear()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getFullYear()},function(e){return new Date(e.value).getFullYear().toString()}):n.getMonth()>a.getMonth()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getMonth()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getFullYear()}):n.getDate()>a.getDate()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getDate()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()}):n.getHours()>a.getHours()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getHours()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+PivotViewer.Utils.getHour(t)+" "+PivotViewer.Utils.getMeridian(t)}):n.getMinutes()>a.getMinutes()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getMinutes()},function(e){var t=new Date(e);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+PivotViewer.Utils.getHour(t)+":"+t.getMinutes()+" "+PivotViewer.Utils.getMeridian(t)}):PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getSeconds()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+PivotViewer.Utils.getHour(t)+":"+t.getMinutes()+"::"+t.getSeconds()+" "+PivotViewer.Utils.getMeridian(t)})):PivotViewer.Utils.getBuckets(t,i)},filter:function(){var e=0;this.buckets=this.bucketize(this.tiles,this.filterList,this.sortCategory),$(".pv-toolbarpanel-info").empty(),null==this.selected&&$(".pv-altinfopanel").fadeIn();for(var t=0;t<PivotCollection.categories.length;t++){var i=PivotCollection.categories[t];if(i.name.toUpperCase().indexOf("GEOMETRY")>=0){for(j=0;j<this.filterList.length;j++){var a=this.filterList[j].item.getFacetByName(i.name);if(void 0!=a){this.geometryValue=a.values[0].value;break}}if(j<this.filterList.length)break}}for(var t=0;t<PivotCollection.categories.length;t++){var i=PivotCollection.categories[t];if(i.name.toUpperCase().indexOf("AREA")>=0)for(j=0;j<this.filterList.length;j++){var a=this.filterList[j].item.getFacetByName(i.name);if(void 0!=a){this.areaValues.push({id:this.filterList[j].item.id,area:a.values[0].value});break}}}for(var i,s=null,n=null,t=0;t<PivotCollection.categories.length;t++){var i=PivotCollection.categories[t],l=i.name.toLowerCase();if(i.isLocation()){0==i.uiInit&&PV.initUICategory(i);break}if(l.indexOf("latitude")>=0?s=i:l.indexOf("longitude")>=0&&(n=i),null!=s&&null!=n){0==s.uiInit&&PV.initUICategory(s),0==n.uiInit&&PV.initUICategory(n);break}}for(var t=0;t<this.filterList.length;t++){var o=this.filterList[t];if((Settings.showMissing||!o.missing)&&void 0==o.loc){var r=null,c=null;if(null!=s&&null!=n){if(r=o.item.getFacetByName(s.name),c=o.item.getFacetByName(n.name),void 0!=r&&void 0!=c){var g=r.values[0].value,p=c.values[0].value;null!=p&&null!=g&&("string"==typeof g&&(g=parseFloat(g)),"string"==typeof p&&(p=parseFloat(p)),isNaN(p)||isNaN(g)||(o.loc=new L.LatLng(g,p)))}}else if(null!=i){var a=o.item.getFacetByName(i.name);if(void 0==a)continue;var h=a.values[0].value;if(0==h.toLowerCase().indexOf("point(")){var p=parseFloat(h.substring(6,h.indexOf(" ",6)-6)),g=parseFloat(h.substring(h.indexOf(" ",6)+1,h.indexOf(")")-(h.indexOf(" ")+1)));isNaN(g)||isNaN(p)||(o.loc=new L.LatLng(g,p))}else if(h.indexOf(",")>-1){var g=parseFloat(h.substring(0,h.indexOf(","))),p=parseFloat(h.substring(h.indexOf(",")));if(isNaN(g)||isNaN(p)){if(h.length>1){var u=h.toUpperCase();if(void 0!=this.locCache[u])o.loc=this.locCache[u];else{var g,p;1e3>e&&(void 0==this.itemsToGeocode[u]&&(this.itemsToGeocode[u]=[],e++),this.itemsToGeocode[u].push(o))}}}else o.loc=new L.LatLng(g,p)}}}}e>0&&this.getLocationsFromNames(),$(".pv-mapview-canvas").css("height",this.height-12+"px"),$(".pv-mapview-canvas").css("width",this.width-415+"px"),this.createMap()},getButtonImage:function(){return"images/MapView.png"},getButtonImageSelected:function(){return"images/MapViewSelected.png"},getViewName:function(){return"Map View"},makeGeocodeCallBack:function(e){var t=this,i=function(i){results=i.results,status=i.status;var a=new L.LatLng(0,0);if(status==google.maps.GeocoderStatus.OK){var s=results[0].geometry.location,n=s.lat,l=s.lng;n&&l&&(a=new L.LatLng(n,l))}t.locCache[e]=a,t.localStorage&&localStorage.setItem(e,JSON.stringify(a));for(var o=0;o<t.itemsToGeocode[e].length;o++)t.itemsToGeocode[e][o].loc=a;delete t.itemsToGeocode[e];var r=new Date;(r.getTime()-t.geocodeZero.getTime())/1e3>20?(t.redrawMarkers(),t.startGeocode=new Date):(r.getTime()-t.startGeocode.getTime())/1e3>2&&(t.redrawMarkers(),t.refitBounds(),t.getOverlay(),t.startGeocode=new Date),0==Object.keys(t.itemsToGeocode).length&&t.createMap()};return i},geocode:function(e,t){var i="http://www.datasciencetoolkit.org/maps/api/geocode/json?sensor=false&address="+encodeURIComponent(e);$.ajax({type:"GET",url:i,dataType:"jsonp",success:function(e){t(e)}})},getLocationsFromNames:function(){for(var e=0;e<Object.keys(this.itemsToGeocode).length;e++){var t=Object.keys(this.itemsToGeocode)[e];this.geocode(t,this.makeGeocodeCallBack(t))}this.startGeocode=new Date,this.startGeocode.setSeconds(this.startGeocode.getSeconds()+2),this.geocodeZero=new Date},createMap:function(){if(null!=this.geometryValue){var e=new Wkt.Wkt;try{e.read(this.geometryValue)}catch(t){try{e.read(this.geometryValue.replace("\n","").replace("\r","").replace("	",""))}catch(i){"WKTError"===i.name&&Debug.log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters.")}}var a=e.toObject(this.map.defaults);if(Wkt.isArray(a))for(var s=0;s<a.length;s++)this.map.addLayer(a[s]);else this.map.addLayer(a)}this.createMarkers(),this.refitBounds(),this.getOverlay(),this.createLegend()},createMarkers:function(){for(this.clearMarkers&&this.clearMarkers(),i=0;i<this.filterList.length;i++){var e=this.filterList[i];void 0==e.loc||!Settings.showMissing&&e.missing||this.newMarker(e)}},drawArea:function(){var e,t=new Wkt.Wkt;this.areaObj&&this.map.removeLayer(this.areaObj);for(var i=0;i<this.areaValues.length;i++)if(this.areaValues[i].id==this.selected.item.id){e=this.areaValues[i].area;break}if(e){var a=!0;try{t.read(e)}catch(s){try{t.read(e.replace("\n","").replace("\r","").replace("	",""))}catch(n){"WKTError"===n.name&&(Debug.log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters."),a=!1)}}if(a)if(this.areaObj=t.toObject({color:"#990000",fillColor:"#EEFFCC",fillOpacity:.6}),Wkt.isArray(this.areaObj))for(var l=0;l<this.areaObj.length;l++)this.map.addLayer(this.areaObj[l]);else this.map.addLayer(this.areaObj)}},redrawMarkers:function(){this.createMarkers(),this.drawArea()},createLegend:function(){var e=$(".pv-altinfopanel").width()-32;$(".pv-altinfopanel").empty(),$(".pv-altinfopanel").append("<div class='pv-legend-heading' style='height:28px' title='"+this.sortCategory+"'>"+this.sortCategory+"</div>");for(var t="<table id='pv-legend-data' style='color:#484848;'>",i=0;i<this.buckets.length;i++){var a="google"==this.mapService?this.icons[i]:(new this.icons[i]).options.iconUrl;t+="<tr><td><img src='"+a+"'></img></td>",t+=this.buckets[i].startRange==this.buckets[i].endRange?"<td><div style='overflow:hidden;white-space:nowrap;width:"+e+"px;text-overflow:ellipsis'>"+this.buckets[i].startLabel+"</div></td></tr>":"<td><div style='overflow:hidden;white-space:nowrap;width:"+e+"px;text-overflow:ellipsis'>"+this.buckets[i].startLabel+" to "+this.buckets[i].endLabel+"</div></td></tr>"}t+="</table>",$(".pv-altinfopanel").append(t)}});
