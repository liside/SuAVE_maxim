//
//  HTML5 PivotViewer
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012-2014 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
PivotViewer.Views.TimeView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super(),this.selectedFacet=0,this.default_showBubble=Timeline.OriginalEventPainter.prototype._showBubble,this.timeFacets=[]
for(var e=0;e<PivotCollection.FacetCategories.length;e++){var t=PivotCollection.FacetCategories[e]
t.Type==PivotViewer.Models.FacetType.DateTime&&this.timeFacets.push({name:t.Name})}this.theme=Timeline.ClassicTheme.create()
var i=this
Timeline.OriginalEventPainter.prototype._showBubble=function(e,t,a){if(null!=i.selected&&i.selected.facetItem.Id==a._id)i.SetSelected(null),$.publish("/PivotViewer/Views/Item/Selected",[{item:n}])
else{var n=TileController.GetTileById(a._id)
i.SetSelected(n),$.publish("/PivotViewer/Views/Item/Selected",[{item:n}])}},this.theme.autoWidth=!1},Setup:function(e,t,i,a){this.width=e,this.height=t,this.offsetX=i,this.offsetY=a,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Activate:function(){if(Modernizr.canvas){this._super(),$(".pv-toolbarpanel-timelineselector").fadeIn(),$(".pv-timeview-canvas").fadeIn(),$(".pv-timeview-canvas").css("height",this.height-12+"px"),$(".pv-timeview-canvas").css("width",this.width-415+"px"),$("#MAIN_BODY").css("overflow","hidden"),$(".pv-toolbarpanel-timelineselector").empty()
for(var e="<select id='pv-timeline-selectcontrol' style='width:126px'>",t=0;t<this.timeFacets.length;t++)e+="<option "+(t==this.selectedFacet?"Facetselected='selected' ":"")+"value='"+t+"'>"+this.timeFacets[t].name+"</option>"
e+="</select>",$(".pv-toolbarpanel-timelineselector").append(e)
var i=this
$("#pv-timeline-selectcontrol").change(function(){i.selectedFacet=$("#pv-timeline-selectcontrol").val(),i.RefreshView(),i.timeline.getBand(0).setCenterVisibleDate(i.timeFacets[i.selectedFacet].eventsData[this.selected.facetItem.Id+"a"].getStart()),$.publish("/PivotViewer/Views/Item/Updated",null)})
var a=PivotCollection.GetFacetCategoryByName(this.timeFacets[this.selectedFacet].name)
a.uiInit||PV.InitUIFacet(a)
var n=this.timeFacets[this.selectedFacet]
void 0==n.interval0&&(void 0!=a.datetimeBuckets.decade&&a.datetimeBuckets.decade.length>1?(n.interval0=Timeline.DateTime.YEAR,n.interval1=Timeline.DateTime.DECADE):void 0!=a.datetimeBuckets.year&&a.datetimeBuckets.year.length>1?(n.interval0=Timeline.DateTime.MONTH,n.interval1=Timeline.DateTime.YEAR):void 0!=a.datetimeBuckets.month&&a.datetimeBuckets.month.length>1?(n.interval0=Timeline.DateTime.DAY,n.interval1=Timeline.DateTime.MONTH):void 0!=a.datetimeBuckets.day&&a.datetimeBuckets.day.length>1?(n.interval0=Timeline.DateTime.HOUR,n.interval1=Timeline.DateTime.DAY):(n.interval0=Timeline.DateTime.DAY,n.interval1=Timeline.DateTime.MINUTE)),this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter)}},Deactivate:function(){this._super(),$(".pv-timeview-canvas").fadeOut(),$(".pv-toolbarpanel-timelineselector").fadeOut()},Filter:function(e,t){Debug.Log("Timeline View Filtered: "+t.length),this.selected=null,this.tiles=e,this.filter=t,this.CreateEventsData()
var i=this.timeFacets[this.selectedFacet]
if(0==this.timeFacets.length||0==i.eventsData.length)return void this.ShowTimeError()
var a=new Timeline.DefaultEventSource,n=[Timeline.createBandInfo({eventSource:a,date:i.eventsData[0].getStart(),width:"80%",intervalUnit:i.interval0,intervalPixels:100,theme:this.theme}),Timeline.createBandInfo({overview:!0,date:i.eventsData[0].getStart(),eventSource:a,width:"20%",intervalUnit:i.interval1,intervalPixels:200,theme:this.theme})]
n[1].highlight=!0,n[1].syncWith=0,n[1].decorators=[new Timeline.SpanHighlightDecorator({inFront:!1,color:"#FFC080",opacity:30,startLabel:"Begin",endLabel:"End",theme:this.theme})],this.timeline=Timeline.create($(".pv-timeview-canvas")[0],n,Timeline.HORIZONTAL),this.timeline.showLoadingMessage(),Timeline.loadJSON("timeline.json",function(e,t){a.loadJSON(e,t)}),this.timeline.hideLoadingMessage(),this.RefreshView(),this.filtered=!1},GetUI:function(){return""},GetButtonImage:function(){return"images/TimeView.png"},GetButtonImageSelected:function(){return"images/TimeViewSelected.png"},GetViewName:function(){return"Time View"},CreateEventsData:function(){this.timeFacets[this.selectedFacet].eventsData=[]
for(var e=0;e<this.filter.length;e++)for(var t=0;t<this.timeFacets.length;t++){var i=this.filter[e],a=i.facetItem.FacetByName[this.timeFacets[t].name]
if(void 0!=a){var n=new Timeline.DefaultEventSource.Event({id:i.facetItem.Id,start:new Date(a.FacetValues[0].Value),isDuration:!1,text:i.facetItem.Name,image:i._images?i._images[0].attributes[0].value:null,link:i.facetItem.Href,caption:i.facetItem.Name,description:i.facetItem.Description})
this.timeFacets[t].eventsData.push(n),this.timeFacets[t].eventsData[i.facetItem.Id+"a"]=n}}},ShowTimeError:function(){var e=""
e+="The current data selection does not contain any information that can be shown on a timeline<br><br>",e+="<br>Choose a different view<br>",$(".pv-wrapper").append('<div id="pv-dzlocation-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+e+"</p></div></div>")
setTimeout(function(){window.open("#pv-dzlocation-error","_self")},1e3)},RefreshView:function(){this.timeline.getBand(0).getEventSource().clear(),this.timeline.getBand(0).getEventSource().addMany(this.timeFacets[this.selectedFacet].eventsData),this.timeline.paint()},SetSelected:function(e){if(null!=this.selected&&(this.timeFacets[this.selectedFacet].eventsData[this.selected.facetItem.Id+"a"]._icon=Timeline.urlPrefix+"images/dull-blue-circle.png"),this._super(e),null!=e){var t=this.timeFacets[this.selectedFacet].eventsData[this.selected.facetItem.Id+"a"]
this.timeline.getBand(0).setCenterVisibleDate(t.getStart()),t._icon=Timeline.urlPrefix+"images/dark-red-circle.png"}}})
