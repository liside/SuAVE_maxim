PivotViewer.Utils.loadScript("src/views/bucketview.min.js"),PivotViewer.Views.CrosstabView=PivotViewer.Views.BucketView.subClass({init:function(){this._super();var t=this;0==$("#pv-altsortcontrols").length&&($("#pv-primsortcontrols").before("<div id='pv-altsortcontrols' class='pv-toolbarpanel-sortcontrols'></div>"),$("#pv-altsortcontrols").hide(),$("#pv-primsort").clone(!0).attr("id","pv-altsort").appendTo($("#pv-altsortcontrols")),$("#pv-altsort").on("change",function(e){if(void 0!=t.bucketsY){t.sortCategory2=$("#pv-altsort option:selected").html();var i=PivotCollection.getCategoryByName(t.sortCategory2);i.uiInit||PV.initUICategory(i);var s=t.filterList.slice(0).sort(tileSortBy(t.sortCategory2));if(Settings.showMissing)t.filterList2=s;else{t.filterList2=[];for(var o=0;o<s.length;o++){var l=s[o];void 0!=l.item.getFacetByName(t.sortCategory2)&&t.filterList2.push(l)}}t.bucketsY=t.bucketize(t.filterList2,t.sortCategory2),t.subbucketize(),t.activate()}}))},getBucket:function(t){return Math.floor((t-this.offsetX-this.columnWidth)/this.columnWidth)},getBucketY:function(t){return this.bucketsY.length-Math.floor(t/this.rowHeight)-1},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount,this.rowscols)},resetUISettings:function(){this.rowscols=this.calculateDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount)},subbucketize:function(){for(var t=0;t<this.buckets.length;t++){var e=this.buckets[t];e.subBuckets=[],e.colCount=0;for(var i=0;i<this.bucketsY.length;i++){var s=this.bucketsY[i];e.subBuckets.push(new PivotViewer.Models.Bucket(s.startRange,s.startLabel,s.endRange,s.endLabel))}}for(var t=0;t<this.filterList.length;t++){var o=this.filterList[t],l=o.item.id,i=this.buckets.ids[l],h=this.bucketsY.ids[l];void 0!=i&&void 0!=h&&(this.buckets[i].subBuckets[h].addTile(o),this.buckets[i].colCount++)}},filterY:function(){if(void 0==this.bucketsY)this.sortCategory2=$("#pv-primsort option:selected").html(),$("#pv-altsort").val($("#pv-primsort").val()),this.bucketsY=this.buckets,this.filterList2=this.filterList;else{var t=[];if(this.filterList.length<this.filterList2.length)for(var e=0;e<this.filterList2.length;e++){var i=this.filterList2[e];void 0!=this.buckets.ids[i.item.id]&&t.push(i)}else{for(var s=[],o=PivotCollection.getCategoryByName(this.sortCategory2),e=0;e<this.filterList.length;e++){var i=this.filterList[e];void 0!=this.bucketsY.ids[i.item.id]||!Settings.showMissing&&void 0==i.item.getFacetByName(this.sortCategory2)||s.push(i)}s.sort(tileSortBy(this.sortCategory2));for(var e=0,l=0;e<this.filterList2.length&&l<s.length;){var h,r,a=this.filterList2[e],n=s[l],c=a.item.getFacetByName(this.sortCategory2),u=n.item.getFacetByName(this.sortCategory2);void 0!=c?void 0!=u?(o.isDateTime()?(h=new Date(c.values[0].value),r=new Date(u.values[0].value)):(h=c.values[0].value,r=u.values[0].value),r>h?(t.push(a),e++):(t.push(n),l++)):(t.push(a),e++):(t.push(n),l++)}for(;e<this.filterList2.length;)t.push(this.filterList2[e++]);for(;l<s.length;)t.push(s[l++])}this.filterList2=t,"db"==$(".pv-facet[facet='"+PV.cleanName(this.sortCategory2).toLowerCase()+"']").attr("mode")?(this.bucketsY=DB.getBuckets(this.sortCategory2),PivotViewer.Utils.fillBuckets(this.bucketsY,this.filterList2,this.sortCategory2)):this.bucketsY=this.bucketize(this.filterList2,this.sortCategory2)}this.subbucketize()},filter:function(){this.buckets=this.bucketize(this.filterList,this.sortCategory),this.filterY()},createUI:function(){$("#pv-altsortcontrols").show(),this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/(this.buckets.length+1),this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,this.rowHeight=this.canvasHeightUIAdjusted/this.buckets[0].subBuckets.length;var t="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; height:"+this.height+"px;''>";this.bigCount=0;for(var e=0;e<this.bucketsY.length;e++){var i=this.bucketsY[e],s=i.startRange==i.endRange||i.startLabel==i.endLabel?s=i.startLabel:i.startLabel+" to "+i.endLabel;t+="<div class='pv-bucketview-overlay-buckettitle-left' style='top: "+(this.bucketsY.length-1-e)*this.rowHeight+"px; height: "+(this.rowHeight-4)+"px; width: "+(this.columnWidth-4)+"px'><div class='pv-bucket-countbox'>"+this.bucketsY[e].tiles.length+"<br>"+Math.round(this.bucketsY[e].tiles.length/this.filterList2.length*100)+"%</div><div class='pv-bucket-label'>"+s+"</div></div>"}t+=this.getStatsBox()+"</div>";for(var e=0;e<this.buckets.length;e++){var i=this.buckets[e];t+="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; left:"+(e+1)*this.columnWidth+"px; height:"+this.height+"px;'>";for(var o=i.subBuckets.length-1;o>=0;o--){var l=i.subBuckets[o],h=e%2==o%2?"bucketview-bucket-dark":"bucketview-bucket-light";(l.equals(PV.subsets[0])||l.equals(PV.subsets[1]))&&(h+=" pv-bucketview-subset"),t+="<div style='height:"+this.rowHeight+"px; top:"+o*this.rowHeight+"px;'><div class='pv-crosstabview-overlay-bucket "+h+"' style='height:"+(this.rowHeight-4)+"px; top: "+o*this.rowHeight+"px;'></div></div>",this.bigCount<l.tiles.length&&(this.bigCount=l.tiles.length)}var s=i.startRange==i.endRange||i.startLabel==i.endLabel?s="<div class='pv-bucket-label'>"+i.startLabel+"</div>":i.startLabel+"<br>to<br>"+i.endLabel;t+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"';'><div class='pv-bucket-countbox'>"+this.buckets[e].colCount+"<br>"+Math.round(this.buckets[e].colCount/this.filterList2.length*100)+"%</div>"+s+"</div></div></div>"}$(".pv-viewpanel-view").append("<div class='pv-bucketview-overlay'></div>"),$(".pv-bucketview-overlay").css("left",this.offsetX+"px").append(t),$(".pv-bucketview-overlay div").fadeIn("slow");for(var e=0;e<this.tiles.length;e++){var r=this.tiles[e],a=r._locations[0];if(a.startx=a.x,a.starty=a.y,r.startwidth=r.width,r.startheight=r.height,!r.filtered||!Settings.showMissing&&r.missing){r.start=PivotViewer.Utils.now(),r.end=r.start+1e3;var n=Math.atan2(a.y-this.currentHeight/2,a.x-this.currentWidth/2);a.destinationx=this.currentWidth*Math.cos(n)+this.currentWidth/2,a.destinationy=this.currentHeight*Math.sin(n)+this.currentHeight/2}}this.maxRatio=TileController._imageController.getRatio(this.tiles[0].item.img);for(var e=0;e<this.filterList.length;e++){var c=TileController._imageController.getRatio(this.filterList[e].item.img);c<this.maxRatio&&(this.maxRatio=c)}var u=this.filterList.length==this.tiles.length?0:500,v=this;setTimeout(function(){var t=$(".pv-toolbarpanel-zoomslider").slider("option","value");t>0&&(v.selected=selectedTile=null,v.currentOffsetX=v.offsetX,v.currentOffsetY=v.offsetY,v.resetUISettings(),PV.zoom(0)),v.resetUISettings();for(var e=TileController._imageController,i=0;i<v.tiles.length;i++)v.tiles[i].origwidth=v.rowscols.TileHeight/e.getRatio(v.tiles[i].item.img),v.tiles[i].origheight=v.rowscols.TileHeight,v.tiles[i].destinationwidth=1,v.tiles[i].destinationheight=1;v.setTilePositions(v.rowscols,v.offsetX,v.offsetY,!1,!1)},u)},deactivate:function(){this._super(),$("#pv-altsortcontrols").hide()},getButtonImage:function(){return"images/CrossTabView.png"},getButtonImageSelected:function(){return"images/CrossTabViewSelected.png"},getViewName:function(){return"Crosstab View"},setTilePositions:function(t,e,i,s,o){var l=o&&this.rowscols?this.rowscols.Columns:t.Columns;o||(this.rowscols=t);for(var h=0;h<this.tiles.length;h++)this.tiles[h].firstFilterItemDone=!1,this.tiles[h]._locations=[this.tiles[h]._locations[0]];for(var r=this.rowHeight*this.scale,a=0;a<this.buckets.length;a++)for(var n=this.buckets[a],c=0;c<n.subBuckets.length;c++)for(var u=n.subBuckets[c],v=0,g=0,d=0;d<u.tiles.length;d++){var b=u.tiles[d];if(b.firstFilterItemDone){var f=new PivotViewer.Views.TileLocation;f.startx=b._locations[0].startx,f.starty=b._locations[0].starty,f.x=b._locations[0].x,f.y=b._locations[0].y,f.destinationx=(a+1)*this.columnWidth+v*t.TileMaxWidth+e,f.destinationy=this.canvasHeightUIAdjusted-c*r-t.TileHeight-g*t.TileHeight+i-10,b._locations.push(f)}else{var f=b._locations[0];s&&(f.startx=f.x,f.starty=f.y,b.startwidth=b.width,b.startheight=b.height),b.destinationwidth=t.TileMaxWidth,b.destinationheight=t.TileHeight,f.destinationx=(a+1)*this.columnWidth+v*t.TileMaxWidth+e,f.destinationy=this.canvasHeightUIAdjusted-c*r-t.TileHeight-g*t.TileHeight+i-10,b.start=PivotViewer.Utils.now(),b.end=b.start+1e3,b.firstFilterItemDone=!0}v==l-1?(v=0,g++):v++}},centerOnTile:function(t){for(var e=t._locations[0],i=t.item,s=this.rowscols.Columns,o=this.rowscols.Rows,l=this.rowscols.TileMaxWidth,h=this.rowscols.TileHeight,r=this.buckets.ids[i.id],a=this.bucketsY.ids[i.id],n=Math.round((e.x-this.currentOffsetX-(r+1)*this.columnWidth)/l),c=o-Math.floor((e.y-this.currentOffsetY-(this.bucketsY.length-a-1)*this.rowHeight*this.scale-this.rowscols.PaddingY)/h),u=this.buckets[r].subBuckets[a],v=c*s+n;(v>u.tiles.length||u.tiles[v]!=t)&&v>=0;)c--,v-=s;var g,d=t.context.canvas.height,b=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());g=t.height/d>t.height/TileController._imageController.getRatio(i.img)/b?t.origheight/d:t.origwidth/b,null==this.selected&&PV.zoom(Math.round(.75/g*2)),this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth/2-(r+1)*this.columnWidth-n*this.rowscols.TileMaxWidth,this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+a*this.rowHeight*this.scale+c*this.rowscols.TileHeight+10,this.setTilePositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},getStatsBox:function(){for(var t,e=0,i=0;i<this.buckets.length;i++)if(t=this.buckets[i],0!=t.tiles.length)for(var s=0;s<this.bucketsY.length;s++){var o=this.bucketsY[s];if(0!=o.tiles.length){var l=t.tiles.length*o.tiles.length/this.filterList.length,h=l-t.subBuckets[s].tiles.length;e+=h*h/l}}e=Math.floor(100*e)/100;var r=pochisq(e,this.buckets.length,t.subBuckets.length),a="";return.001>r?a="***":.01>r?a="**":.05>r&&(a="*"),"<div class='pv-crosstabview-overlay-statsbox' style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+this.bucketsY.length*this.rowHeight+"px;'><div style='text-align:center'>"+this.sortCategory2+"</div><div class='pv-bucket-countbox' title='chi-squared'>X<sup>2</sup><br>"+e+a+"</div><div style='position:absolute; right:2px;'>"+this.sortCategory+"</div></div>"},handleHover:function(t){if(this.super_handleHover(t),$(".pv-crosstabview-overlay-bucket").removeClass("bucketview-bucket-hover"),$(".pv-tooltip").remove(),!(this.scale>1)){var e=this.getBucket(t.x),i=this.getBucketY(t.y);if(e>=0&&i>=0)return void $(".pv-crosstabview-overlay-bucket").eq(e*this.bucketsY.length+(this.bucketsY.length-i-1)).addClass("bucketview-bucket-hover");var s,o,l,h;if(!(-1>e||-1>i)){if(-1==e){if(-1==i)return $(".pv-bucketview-overlay").append("<div class='pv-tooltip'>chi-squared</div>"),void $(".pv-tooltip").offset($(".pv-crosstabview-overlay-statsbox").offset());l=i,s=$(".pv-bucketview-overlay-buckettitle-left").eq(l),o=this.bucketsY[l],h=this.sortCategory2}else{if(-1!=i)return;l=e,s=$(".pv-bucketview-overlay-buckettitle").eq(l),o=this.buckets[l],h=this.sortCategory}var r=PivotCollection.getCategoryByName(h).isString(),a="<div class='pv-tooltip'>"+h+" Bucket "+(l+1)+":<br>"+(o.startLabel==o.endLabel?" Value: "+(r?'"':"")+o.startLabel+(r?'"':"")+"<br>":"Values: from "+(r?'"':"")+o.startLabel+(r?'"':"")+"  to "+(r?'"':"")+o.endLabel+(r?'"':"")+"<br>")+o.tiles.length+" of "+this.filterList2.length+" items ("+Math.round(o.tiles.length/this.filterList2.length*100)+"%)"+(Settings.showMissing?"</div>":"<br><i>(Some items may be missing values for this variable.)</i></div>");$(".pv-bucketview-overlay").append(a),$(".pv-tooltip").offset(s.offset())}}},handleClick:function(t){if(this.hasSubsets()&&!PV.subsets.finalized)return PV.subsets.finalized=!0,void PV.filterViews();var e=this.super_handleClick(t);if(null!=this.selected&&this.selected.setSelected(!1),null!=e)this.selected!=e?(e.setSelected(!0),this.centerOnTile(e),this.setSelected(e),$(".pv-bucketview-overlay div").fadeOut("slow")):(e=null,this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));else{this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow");var i=this.getBucket(t.x),s=this.getBucketY(t.y);if(i>=0){var o=this.buckets[i];if(s>=0){var l=this.bucketsY[s];$.publish("/PivotViewer/Views/Item/Filtered",[[{category:this.sortCategory,min:o.startRange,max:o.endRange,values:o.values},{category:this.sortCategory2,min:l.startRange,max:l.endRange,values:l.values}]])}else $.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory,min:o.startRange,max:o.endRange,values:o.values}])}else if(s>=0){var l=this.bucketsY[s];$.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory2,min:l.startRange,max:l.endRange,values:l.values}])}}$.publish("/PivotViewer/Views/Item/Selected",[{item:e}])},handleContextMenu:function(t){var e=this.getBucket(t.x),i=this.getBucketY(t.y),s=$(".pv-crosstabview-overlay-bucket").eq(e*this.bucketsY.length+(this.bucketsY.length-i-1));this.addSubset(this.buckets[e].subBuckets[i])?s.addClass("pv-bucketview-subset"):s.removeClass("pv-bucketview-subset")}});