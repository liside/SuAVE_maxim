var DB={_isOn:!1}
DB.on=function(){if(!DB._isOn){DB._isOn=!0
var e=function(e){var n=$(e.target)
n.parent().parent().parent().prev().removeAttr("mode")
var a=n.parent().parent().find(".pv-facet-order")
a.siblings(".pv-facet-value").show(),a.siblings(".pv-facet-value-label").off(".db"),a.siblings(".pv-facet-value-label").one("contextmenu.db",t),a.remove()},t=function(n){var a=$(n.target)
if(a.hasClass(".pv-facet-value-label")&&(a=a.siblings(".pv-facet-value")),void 0!=a.parent().parent().parent().prev().attr("mode"))return a.one("contextmenu.db",t),!1
a.off("contextmenu.db"),a.parent().parent().parent().prev().attr("mode","db")
for(var i=a.parent().parent().find(".pv-facet-value"),r=i.filter(".pv-facet-value:checked"),l="<select class='pv-facet-order'><option value='-1'>--",o=1,d=i.length>9?9:i.length;o<=d;o++)l+="<option value='"+o+"'>"+o
return l+="</select>",i.after(l),0==r.length?i.siblings(".pv-facet-order").val(1):r.siblings(".pv-facet-order").val(1),i.hide(),i.siblings(".pv-facet-value-label").off("contextmenu.db"),i.siblings(".pv-facet-order").on("contextmenu.db",function(t){return e(t),PV.filterViews(),!1}),i.siblings(".pv-facet-value-label").bindFirst("click.db",function(e){var t=$(this).siblings().filter(".pv-facet-order")
t.val()==-1?t.val(1):t.val(-1),e.stopImmediatePropagation(),t.change()}),i.siblings(".pv-facet-order").change(function(){var e=$(this),t=e.parent().parent().find(".pv-facet-value:checked")
0==t.length?(e.val()==-1&&(e.parent().siblings().find(".pv-facet-value").prop("checked",!0),PV.filterCollection()),PV.filterCollection()):e.val()==-1&&0!=e.siblings(".pv-facet-value:checked").length?e.siblings(".pv-facet-value").click():e.val()!=-1&&0==e.siblings(".pv-facet-value:checked").length?e.siblings(".pv-facet-value").click():PV.filterCollection()}),i.siblings(".pv-facet-value-label").one("contextmenu.db",function(t){return e(t),PV.filterViews(),!1}),PV.filterViews(),!1},n=function(e){var t=$(e.target)
t.hasClass("ui-slider-handle")&&(t=t.parent()),t.parent().parent().prev().removeAttr("mode"),t.off(".db")
var n=t.modSlider("option","values")
t.modSlider("option","values",[n[0],n[n.length-1]]),t.modSlider("option","range",!0),t.parent().find(".pv-facet-numericslider-range-val").text(n[0]+" - "+n[n.length-1]),t.modSlider("option","slide",function(e,t){$(this).parent().find(".pv-facet-numericslider-range-val").text(t.values[0]+" - "+t.values[t.values.length-1])}),t.one("contextmenu.db",a)},a=function(e){var t=$(this)
return void 0!=t.parent().parent().prev().attr("mode")?(t.one("contextmenu.db",a),!1):(t.parent().parent().prev().attr("mode","db"),t.modSlider("option","range",!1),t.off("contextmenu.db"),t.one("contextmenu.db",function(e){return n(e),PV.filterViews(),!1}),t.bindFirst("mousedown.db",function(e){if(1!=e.which)return!1
if(!e.target||!$(e.target).hasClass("ui-slider-handle")){var t=$(this),n=(e.pageX-t.offset().left)*(t.modSlider("option","max")-t.modSlider("option","min"))/t.width()+t.modSlider("option","min")
t.modSlider("addValue",n)
for(var a=t.modSlider("option","values"),i=a[0],r=1;r<a.length;r++)i+=" - "+a[r]
$(this).parent().find(".pv-facet-numericslider-range-val").text(i),e.stopImmediatePropagation(),PV.filterViews()}}),t.on("mousedown.db",".ui-slider-handle",function(e){if(1!=e.which)return!1
var t=$(this)
t.hasClass("ui-slider")?e.target&&$(e.target).hasClass("ui-slider-handle")&&$(e.target).attr("startx",e.pageX):t.attr("startx",e.pageX)}),t.modSlider("option","slide",function(e,t){var n=$(this),a=t.values.indexOf(t.value),i=n.modSlider("option","step")
if(a<t.values.length-1&&t.value>=t.values[a+1]-i||a>0&&t.value<=t.values[a-1]+i)return!1
for(var r=t.values[0],l=1;l<t.values.length;l++)r+=" - "+t.values[l]
$(this).parent().parent().find(".pv-facet-numericslider-range-val").text(r)}),t.bindFirst("mouseup.db",".ui-slider-handle",function(e){if(1!=e.which)return!1
var t=$(this)
t.hasClass("ui-slider")?e.target&&$(e.target).hasClass("ui-slider-handle")&&(t=$(e.target)):t=$(this)
var n=t.parent().children(".ui-slider-handle"),a=n.index(t)
if(t.attr("startx")&&e.pageX-t.attr("startx")==0&&a>=0&&a<n.length-1){t.parent().modSlider("removeValue",a)
for(var i=t.parent().modSlider("option","values"),r=i[0],l=1;l<i.length;l++)r+=" - "+i[l]
$(this).parent().parent().find(".pv-facet-numericslider-range-val").text(r),PV.filterViews()}}),PV.filterViews(),!1)}
$(".pv-facet-value").each(function(){var e=$(this),n=PivotCollection.getCategoryByName(e.parent().parent().parent().prev().children("a").attr("title"))
n.isDateTime()||(e.one("contextmenu.db",t),e.siblings(".pv-facet-value-label").on("contextmenu.db",t))}),$(".pv-facet-numericslider").each(function(){var e=$(this)
e.one("contextmenu.db",a)}),$(".pv-facet").on("click.db",function(e){var n=$(this),i=PivotCollection.getCategoryByName(n.children("a").attr("title"))
i.isDateTime()||(i.isNumber()||i.isOrdinal()?n.next().find(".pv-facet-numericslider").each(function(){var e=$(this)
e.off("contextmenu.db"),e.one("contextmenu.db",a)}):n.next().find(".pv-facet-value").each(function(){var e=$(this)
e.off("contextmenu.db"),e.one("contextmenu.db",t),e.siblings(".pv-facet-value-label").off("contextmenu.db"),e.siblings(".pv-facet-value-label").one("contextmenu.db",t)}))}),$(".pv-filterpanel-clearall").bindFirst("click.db",function(){var t=$(".pv-facet[mode='db']")
t.next().find("li:first-of-type").find(".pv-facet-order").each(function(t,n){e({target:n})}),t.next().find(".pv-facet-numericslider").each(function(e,t){n({target:t})})}),$(".pv-filterpanel-accordion-heading-clear").bindFirst("click.db",function(){var t=$(this)
"db"==t.parent().attr("mode")&&(t.parent().next().find(".pv-facet-order").eq(0).each(function(t,n){e({target:n})}),t.parent().next().find(".pv-facet-numericslider").each(function(e,t){n({target:t})}))}),DB._stopSlider=PV._stopSlider,PV._stopSlider=function(e,t,n,a){var i=e.modSlider("option","values"),r=i.indexOf(a.value)
"db"==!e.attr("mode")||0==r||r==i.length-1?DB._stopSlider(e,t,n,a):PV.filterCollection()}}},DB.off=function(){DB._isOn&&(DB._isOn=!1,$(".pv-facet").off("click.db"),$(".pv-facet-value").off("contextmenu.db"),$(".pv-facet-value-label").off("contextmenu.db"),$(".pv-facet-order").remove(),$(".pv-facet[mode='db']").removeAttr(mode),$(".pv-facet-numericslider").off("contextmenu.db"),$(".pv-facet-numericslider").off("click.db"),$(".pv-facet-numericslider").off("mousedown.db"),PV._stopSlider=DB._stopSlider,$(".pv-filterpanel-clearall").off("click.db"),$(".pv-filterpanel-accordion-heading-clear").off("click.db"),PV.filterViews())},DB.isOn=function(){return DB._isOn},DB.isDB=function(e){"object"==typeof e&&(e=e.name)
var t=$(".pv-facet[facet='"+PV.cleanName(e.name.toLowerCase())+"']")
return"db"==t.attr("mode")},DB.getBuckets=function(e){"string"==typeof e&&(e=PivotCollection.getCategoryByName(e))
var t=$(".pv-facet[facet='"+PV.cleanName(e.name.toLowerCase())+"']")
if("db"!=t.attr("mode"))return null
var n=[]
if(e.isNumber()||e.isOrdinal())for(var a=t.next().find(".pv-facet-numericslider").modSlider("option","values"),i=0;i<a.length-1;i++)n[i]=new PivotViewer.Models.Bucket(a[i],e.getValueLabel(a[i]),a[i+1],e.getValueLabel(a[i+1]))
else{n.values=[]
for(var r=t.next().find("li"),i=0;i<r.length;i++){var l=r.eq(i).find(".pv-facet-order").val()-1
if(!(l<0)){var o=r.eq(i).find(".pv-facet-value-label").text()
void 0==n[l]?n[l]=new PivotViewer.Models.Bucket(o,o):n[l].endRange=n[l].endLabel=o,n.values[o]=l,n[l].addValue(o)}}for(i=0;i<n.length;i++)void 0==n[i]&&(n[i]=new PivotViewer.Models.Bucket(null,"empty"))}return n}
