//
//  HTML5 PivotViewer
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012-2014 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
PivotViewer.Utils.loadScript("src/views/crosstabview.min.js"),PivotViewer.Utils.loadScript("src/views/iv.min.js"),PivotViewer.Views.QcaView=PivotViewer.Views.CrosstabView.subClass({init:function(){this._super(),this.singleEq=!1
var e=this
$.subscribe("/PivotViewer/Views/IVFiltered",function(t){e.filtered=!0,e.activate()})},filterY:function(){this.subbucketize()},bucketize:function(e,t,i){var s=IV.getIV()
if(null==s)return null
var r=PivotCollection.getCategoryByName(t),l=[]
l.ids=[],l[0]=new PivotViewer.Models.Bucket("","True Positive"),l[1]=new PivotViewer.Models.Bucket("","False Positive"),this.singleEq&&(l[2]=new PivotViewer.Models.Bucket("","True Negative"),l[3]=new PivotViewer.Models.Bucket("","False Negative"))
for(var a=0;a<l.length;a++)l[a].colCount=0,l[a].subBuckets=[],l[a].subBuckets.ids=[]
if(this.singleEq&&i){for(a=0;a<l.length;a++)l[a].subBuckets[0]=new PivotViewer.Models.Bucket(i.startRange,i.startLabel)
for(i.tiles=[],i.ids=[],a=0;a<this.filterList.length;a++){var o,n,c=this.filterList[a]
i.addTile(c),n=i==this.bucketsY[this.bucketsY.ids[c.item.id]]?i.oldBkt.ids[c.item.id]?0:1:i.oldBkt.ids[c.item.id]?3:2,o=l[n],o.addTile(c),o.colCount++,l.ids[c.item.id]=n,o.subBuckets[0].addTile(c),o.subBuckets.ids[c.item.id]=0,this.bucketsY.ids[c.item.id]=0}var h=this.bucketsY.ids
this.bucketsY=[i],this.bucketsY.ids=h}else{var d=this._super(e,t),u=[]
for(this.contribd=[],this.contribn=[],a=0;a<d.length;a++)if(d[a].order=a,u[a]=[],this.contribn[a]=[],0==s.categories.length)u[a][1]=0
else for(n=0;n<1<<s.categories.length;n++)u[a][n]=0
var v=[]
for(a=0;a<e.length;a++){var c=e[a],b=c.item.getFacetByName(r.name)
if(void 0!=b){if(0==s.categories.length)c.bits=1
else{for(var g=0,n=0;n<s.categories.length;n++){var f=s.categories[n],k=c.item.getFacetByName(f.name)
if(void 0==k)break
ivalue=k.values[0].value,f.isString()?s.values[n][ivalue]&&(g|=1<<n):s.values[n][0]<=ivalue&&s.values[n][1]>=ivalue&&(g|=1<<n)}if(n<s.categories.length)continue
c.bits=g}var o=d.ids[c.item.id]
b.values[0].value
if(u[o][c.bits]++,0==s.categories.length)this.contribn[o].a++,this.contribd.a++
else for(n=0;n<s.categories.length;n++){var w=""
n<s.categories.length-1&&(w+=c.bits>>n+1),w+="a",n>0&&(w+=c.bits%(1<<n)),void 0==this.contribn[o][w]&&(this.contribn[o][w]=0,void 0==this.contribd[w]&&(this.contribd[w]=0)),this.contribn[o][w]++,this.contribd[w]++}v.push(c)}}this.filterList2=this.filterList=v,this.bucketsY=[],this.bucketsY.ids=[]
var p=[],m=[]
if(0==s.categories.length)m[1]=0
else for(a=0;a<1<<s.categories.length;a++)m[a]=0
for(a=0;a<d.length;a++)if(void 0!=u[a]){var o=d[a]
if(0==s.categories.length)u[a][1]>m[1]&&(m[1]=u[a][1],p[1]=o)
else for(n=0;n<1<<s.categories.length;n++){var V=u[a][n]
V>m[n]&&(m[n]=V,p[n]=o)}}var B=[]
for(a=0,order=0;a<p.length;a++)if(void 0!=p[a]){var y=new PivotViewer.Models.Bucket(null,null)
y.oldBkt=p[a],y.order=order++,y.eq=a,this.bucketsY.push(y),B[a]=y}for(a=0;a<l.length;a++)for(var o=l[a],n=0;n<this.bucketsY.length;n++){var i=this.bucketsY[n]
o.subBuckets[n]=new PivotViewer.Models.Bucket(i.startRange,i.startLabel)}for(a=0;a<v.length;a++){var o,n,c=v[a],i=B[c.bits]
i.addTile(c),this.bucketsY.ids[c.item.id]=i.order,n=i.oldBkt.ids[c.item.id]?0:1,o=l[n],l.ids[c.item.id]=n,o.addTile(c),o.colCount++,o.subBuckets[i.order].addTile(c),o.subBuckets.ids[c.item.id]=i.order}for(a=0;a<this.bucketsY.length;a++){var i=this.bucketsY[a],P=""
if(0==s.categories.length)P+="∅"
else for(n=0;n<s.categories.length;n++)P+=(i.eq>>n&1?"":"~")+s.categories[n].ivCode+(n<s.categories.length-1?" ^ ":"")
P+="<br>&#8594; "+this.sortCategory+": ("+i.oldBkt.getLabel()+")",i.startLabel=i.endLabel=P}}return l},activate:function(){IV.on(),this.filtered&&(this.singleEq=!1),this._super(),$("#pv-altsortcontrols").hide()},deactivate:function(){IV.off(),this.singleEq=!1,this._super(),this.filtered=!0},getViewName:function(){return"QCA View"},getButtonImage:function(){return"images/QCAView.png"},getButtonImageSelected:function(){return"images/QCAViewSelected.png"},getStatsBox:function(){return"<div style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+i*this.rowHeight+"px;'><div style='text-align:center'>Equations</div><div style='position:absolute; right:2px;'>Result</div></div>"},handleHover:function(e){if(this.super_handleHover(e),$(".pv-crosstabview-overlay-bucket").removeClass("bucketview-bucket-hover"),$(".pv-tooltip").remove(),!(this.scale>1)){var t=this.getBucket(e.x),i=this.getBucketY(e.y)
if(t>=0&&i>=0)return void $(".pv-crosstabview-overlay-bucket").eq(t*this.bucketsY.length+(this.bucketsY.length-i-1)).addClass("bucketview-bucket-hover")
var s,r,l
if(!(t<-1||i<-1)){if(t==-1){if(i==-1)return
if(s=$(".pv-bucketview-overlay-buckettitle-left").eq(i),r=this.bucketsY[i],l="Dependent Variable: "+this.sortCategory+"<br>Predicted Values: ",r.oldBkt.values.length>0){l+=r.oldBkt.values[0]
for(var a=1;a<r.oldBkt.values.length;a++)l+=", "+r.oldBkt.values[a]}else l+="from "+r.oldBkt.startLabel+" (inclusive) to "+r.oldBkt.endLabel+" (exclusive)"
l+="<br><br>Independent Variables:<br>"
var o=IV.getIV()
for(a=0;a<o.categories.length;a++){var n=""
a<o.categories.length-1&&(n+=r.eq>>a+1),n+="a",a>0&&(n+=r.eq%(1<<a))
var c=this.buckets[0].subBuckets[i].tiles.length/r.tiles.length
c-=o.categories.length>1?this.contribn[r.oldBkt.order][n]/this.contribd[n]:r.oldBkt.tiles.length/this.filterList.length,c=Math.floor(100*c)
var h=o.categories[a],d=o.values[a]
if(l+=h.ivCode,"∅"!=h.ivCode){if(l+=". "+h.name+(r.eq>>a&1?" (true)":" (false)")+"<br>Defined True Values: ",h.isNumber()||h.isOrdinal())l+="from "+d[0]+" (inclusive) to "+d[1]+" (exclusive)"
else{l+=d[0]
for(var u=1;u<d.length;u++)l+=", "+d[u]}l+="<br>Adjusts Prediction Accuracy by: "+c+"%"}else l+=" (No Independent Variables Selected)"
a<o.categories.length-1&&(l+="<br><br>")}}else{if(i!=-1)return
s=$(".pv-bucketview-overlay-buckettitle").eq(t),0==t?l="Items that match the characteristics described by the independent variables<br>and for which the dependent variable has been correctly predicted.":1==t?l="Items that match the characteristics described by the independent variables<br>but for which the dependent variable has been incorrectly predicted.":2==t?l="Items that do not match the characteristics<br>described by the independent variables<br>and for which the value of the dependent variable<br>correctly does not match the given value.":3==t&&(l="Items that do not match the characteristics<br>described by the independent variables<br>but for which the value of the dependent variables<br>incorrectly does match the given value.")}s.offset()
l="<div class='pv-tooltip'>"+l+"</div>",$(".pv-bucketview-overlay").append(l),$(".pv-tooltip").offset(s.offset())}}},handleClick:function(e){if(this.hasSubsets()&&!PV.subsets.finalized)return PV.subsets.finalized=!0,void PV.filterViews()
var t=this.super_handleClick(e)
if(null!=this.selected&&this.selected.setSelected(!1),null!=t)this.selected!=t?(t.setSelected(!0),this.centerOnTile(t),this.setSelected(t),$(".pv-bucketview-overlay div").fadeOut("slow")):(t=null,this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"))
else{if(this.singleEq)this.singleEq=!1,this.buckets=this.bucketize(this.filterList,this.sortCategory)
else{var i=this.getBucketY(e.y)
i>=0&&(this.singleEq=!0,this.buckets=this.bucketize(this.filterList,this.sortCategory,this.bucketsY[i]))}this.activate()}$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])}})
