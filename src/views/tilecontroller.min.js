PivotViewer.Views.TileController=Object.subClass({init:function(n){this._tiles=[];this._tilesById=[];this._easing=new Easing.Easer({type:"circular",side:"both"});this._imageController=n;var t=this;this._tiles.push=function(n){this.__proto__.push.apply(t._tiles,[n]);t._tilesById[n.item.id]=n}},getTileById:function(n){var t=this._tilesById[n];return t==undefined?null:t},initTiles:function(n,t,i){for(var r,u=0;u<n.length;u++)r=new PivotViewer.Views.Tile(this._imageController),r.item=n[u],this._canvasContext=i,r.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,r._locations.push(tileLocation),this._tiles.push(r);return this._tiles},animateTiles:function(){var e=this,i,f,r,u,n,t;if(this._started=!0,i=null,this._tiles.length>0&&this._tiles[0].context!=null)for(i=this._tiles[0].context,f=!1,n=0;n<this._tiles.length;n++)for(t=0;t<this._tiles[n]._locations.length;t++)r=PivotViewer.Utils.now()-this._tiles[n].start,u=this._tiles[n].end-this._tiles[n].start,r<=u?((this._tiles[n]._locations[t].x!=this._tiles[n]._locations[t].destinationx||this._tiles[n]._locations[t].y!=this._tiles[n]._locations[t].destinationy)&&(f=!0),this._tiles[n]._locations[t].x=this._easing.ease(r,this._tiles[n]._locations[t].startx,this._tiles[n]._locations[t].destinationx-this._tiles[n]._locations[t].startx,u),this._tiles[n]._locations[t].y=this._easing.ease(r,this._tiles[n]._locations[t].starty,this._tiles[n]._locations[t].destinationy-this._tiles[n]._locations[t].starty,u),(this._tiles[n].width!=this._tiles[n].destinationWidth||this._tiles[n].height!=this._tiles[n].destinationHeight)&&(f=!0),this._tiles[n].width=this._easing.ease(r,this._tiles[n].startwidth,this._tiles[n].destinationwidth-this._tiles[n].startwidth,u),this._tiles[n].height=this._easing.ease(r,this._tiles[n].startheight,this._tiles[n].destinationheight-this._tiles[n].startheight,u)):(this._tiles[n]._locations[t].x=this._tiles[n]._locations[t].destinationx,this._tiles[n]._locations[t].y=this._tiles[n]._locations[t].destinationy,this._tiles[n].width=this._tiles[n].destinationwidth,this._tiles[n].height=this._tiles[n].destinationheight),this._tiles[n].destinationVisible=this._tiles[n]._locations[t].destinationx+this._tiles[n].destinationwidth<0||this._tiles[n]._locations[t].destinationx>i.canvas.width||this._tiles[n]._locations[t].destinationy+this._tiles[n].destinationheight<0||this._tiles[n]._locations[t].destinationy>i.canvas.height?!1:!0;for(this._isZooming!=f&&(this._isZooming=f,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),i.clearRect(0,0,i.canvas.width,i.canvas.height),n=0;n<this._tiles.length;n++)for(t=0;t<this._tiles[n]._locations.length;t++)this._tiles[n]._locations[t].x+this._tiles[n].width>0&&this._tiles[n]._locations[t].x<i.canvas.width&&this._tiles[n]._locations[t].y+this._tiles[n].height>0&&this._tiles[n]._locations[t].y<i.canvas.height&&this._tiles[n].draw(t);this._breaks?this._started=!1:requestAnimFrame(function(){e.animateTiles()})},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}});PivotViewer.Views.Tile=Object.subClass({init:function(n){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(n);this._imageLoaded=!1;this._selected=!1;this._images=null;this._locations=[];this._visible=!0},draw:function(n){var i,r,u;if(this.destinationVisible&&(this._images=TileController._imageController.getImages(this.item.img,this.width,this.height)),this._images!=null){if(typeof this._images=="function")this._images(this.item,this.context,this._locations[n].x+4,this._locations[n].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var c=TileController._imageController.getHeight(this.item.img),f=this.height-Math.ceil(this.height<128?this.height/16:8),o=Math.ceil(TileController._imageController.getWidthForImage(this.item.img,f));if(blankWidth=this.width-8-o,TileController._imageController instanceof PivotViewer.Views.DeepZoomImageController)for(i=0;i<this._images.length;i++){var s=this._images[i].src,h=TileController._imageController._tileSize,t=s.match(/[0-9]+_[0-9]+/g),l=parseInt(t[t.length-1].substring(0,t[t.length-1].indexOf("_"))),a=parseInt(t[t.length-1].substring(t[t.length-1].indexOf("_")+1));t=s.match(/_files\/[0-9]+\//g);var v=parseInt(t[0].substring(7,t[0].length-1)),y=Math.ceil(c/Math.pow(2,TileController._imageController.getMaxLevel(this.item.img)-v)),e=f/y;overlap=TileController._imageController.getOverlap(this.item.img);var r=Math.floor(blankWidth/2)+4+l*Math.floor((h-overlap)*e),u=4+Math.floor(a*(h-overlap)*e),p=Math.ceil(this._images[i].height*e),w=Math.ceil(this._images[i].width*e);this.context.drawImage(this._images[i],r+this._locations[n].x,u+this._locations[n].y,w,p)}else r=Math.floor(blankWidth/2)+4,u=4,this.context.drawImage(this._images[0],r+this._locations[n].x,u+this._locations[n].y,o,f);this._selected&&(this.context.beginPath(),r=Math.floor(blankWidth/2)+4,u=4,this.context.rect(r+this._locations[this.selectedLoc].x,u+this._locations[this.selectedLoc].y,o,f),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke())}}else this.drawEmpty(n)},contains:function(n,t){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=n&&this._locations[i].x+this.width>=n&&this._locations[i].y<=t&&this._locations[i].y+this.height>=t)return i;return-1},drawEmpty:function(n){TileController._imageController.DrawLevel==undefined?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[n].x+4,this._locations[n].y+4,this.width-8,this.height-8),this.context.rect(this._locations[n].x+4,this._locations[n].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):TileController._imageController.DrawLevel(this.item,this.context,this._locations[n].x+4,this._locations[n].y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(n){this._selected=n}});PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});