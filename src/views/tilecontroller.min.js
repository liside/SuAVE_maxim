PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._tilesById=[],this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a;var b=this;this._tiles.push=function(a){this.__proto__.push.apply(b._tiles,[a]),b._tilesById[a.item.id]=a}},getTileById:function(a){var b=this._tilesById[a];return void 0==b?null:b},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.item=a[d],this._canvasContext=c,e.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,e._locations.push(tileLocation),this._tiles.push(e)}return this._tiles},animateTiles:function(){var a=this;this._started=!0;var b=null;if(this._tiles.length>0&&null!=this._tiles[0].context){b=this._tiles[0].context,b.canvas.width=$(".pv-canvas").width(),b.canvas.height=$(".pv-canvas").height();for(var c=!1,d=0;d<this._tiles.length;d++)for(g=0;g<this._tiles[d]._locations.length;g++){var e=PivotViewer.Utils.now()-this._tiles[d].start,f=this._tiles[d].end-this._tiles[d].start;e<=f?(this._tiles[d]._locations[g].x==this._tiles[d]._locations[g].destinationx&&this._tiles[d]._locations[g].y==this._tiles[d]._locations[g].destinationy||(c=!0),this._tiles[d]._locations[g].x=this._easing.ease(e,this._tiles[d]._locations[g].startx,this._tiles[d]._locations[g].destinationx-this._tiles[d]._locations[g].startx,f),this._tiles[d]._locations[g].y=this._easing.ease(e,this._tiles[d]._locations[g].starty,this._tiles[d]._locations[g].destinationy-this._tiles[d]._locations[g].starty,f),this._tiles[d].width==this._tiles[d].destinationWidth&&this._tiles[d].height==this._tiles[d].destinationHeight||(c=!0),this._tiles[d].width=this._easing.ease(e,this._tiles[d].startwidth,this._tiles[d].destinationwidth-this._tiles[d].startwidth,f),this._tiles[d].height=this._easing.ease(e,this._tiles[d].startheight,this._tiles[d].destinationheight-this._tiles[d].startheight,f)):(this._tiles[d]._locations[g].x=this._tiles[d]._locations[g].destinationx,this._tiles[d]._locations[g].y=this._tiles[d]._locations[g].destinationy,this._tiles[d].width=this._tiles[d].destinationwidth,this._tiles[d].height=this._tiles[d].destinationheight),this._tiles[d]._locations[g].destinationx+this._tiles[d].destinationwidth<0||this._tiles[d]._locations[g].destinationx>b.canvas.width||this._tiles[d]._locations[g].destinationy+this._tiles[d].destinationheight<0||this._tiles[d]._locations[g].destinationy>b.canvas.height?this._tiles[d].destinationVisible=!1:this._tiles[d].destinationVisible=!0}}this._isZooming!=c&&(this._isZooming=c,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),b.clearRect(0,0,b.canvas.width,b.canvas.height);for(var d=0;d<this._tiles.length;d++)for(var g=0;g<this._tiles[d]._locations.length;g++)this._tiles[d]._locations[g].x+this._tiles[d].width>0&&this._tiles[d]._locations[g].x<b.canvas.width&&this._tiles[d]._locations[g].y+this._tiles[d].height>0&&this._tiles[d]._locations[g].y<b.canvas.height&&this._tiles[d].draw(g);this._breaks?this._started=!1:requestAnimFrame(function(){a.animateTiles()})},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){return this instanceof PivotViewer.Views.Tile?(this._imageLoaded=!1,this._selected=!1,this._images=null,this._locations=[],void(this._visible=!0)):new PivotViewer.Views.Tile(a)},draw:function(a){if(this.destinationVisible&&(this._images=TileController._imageController.getImages(this.item.img,this.width,this.height)),null!=this._images){if("function"==typeof this._images)this._images(this.item,this.context,this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var b=TileController._imageController.getHeight(this.item.img),c=this.height-Math.ceil(this.height<128?this.height/16:8),d=Math.ceil(TileController._imageController.getWidthForImage(this.item.img,c));if(blankWidth=this.width-8-d,TileController._imageController instanceof PivotViewer.Views.DeepZoomImageController)for(var e=0;e<this._images.length;e++){var f=this._images[e].src,g=TileController._imageController._tileSize,h=f.match(/[0-9]+_[0-9]+/g),i=parseInt(h[h.length-1].substring(0,h[h.length-1].indexOf("_"))),j=parseInt(h[h.length-1].substring(h[h.length-1].indexOf("_")+1));h=f.match(/_files\/[0-9]+\//g);var k=parseInt(h[0].substring(7,h[0].length-1)),l=Math.ceil(b/Math.pow(2,TileController._imageController.getMaxLevel(this.item.img)-k)),m=c/l;overlap=TileController._imageController.getOverlap(this.item.img);var n=Math.floor(blankWidth/2)+4+i*Math.floor((g-overlap)*m),o=4+Math.floor(j*(g-overlap)*m),p=Math.ceil(this._images[e].height*m),q=Math.ceil(this._images[e].width*m);this.context.drawImage(this._images[e],n+this._locations[a].x,o+this._locations[a].y,q,p)}else{var n=Math.floor(blankWidth/2)+4,o=4;this.context.drawImage(this._images[0],n+this._locations[a].x,o+this._locations[a].y,d,c)}if(this._selected){this.context.beginPath();var n=Math.floor(blankWidth/2)+4,o=4;this.context.rect(n+this._locations[this.selectedLoc].x,o+this._locations[this.selectedLoc].y,d,c),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke()}}}else this.drawEmpty(a)},contains:function(a,b){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=a&&this._locations[i].x+this.width>=a&&this._locations[i].y<=b&&this._locations[i].y+this.height>=b)return i;return-1},drawEmpty:function(a){void 0==TileController._imageController.DrawLevel?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8),this.context.rect(this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):TileController._imageController.DrawLevel(this.item,this.context,this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(a){this._selected=a}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});
