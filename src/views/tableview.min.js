//
//  HTML5 PivotViewer
//
//  Collection loader interface - used so that different types of data sources can be used
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012-2014 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
///
/// Table view
///
PivotViewer.Views.TableView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super(),this.filter=null,this.selectedFacet=null,this.sortKey="pv-key",this.sortReverse=!1,this.sortReverseEntity=!1,this.sortReverseAttribute=!1,this.sortReverseValue=!1},Setup:function(e,t,i,l,r){this.width=e,this.height=t,this.offsetX=i,this.offsetY=l,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-viewpanel").append("<div class='pv-tableview-table' id='pv-table'></div>"),$(".pv-viewpanel").append("<div style='visibility:hidden;position:relative;' id='pv-table-loader'><img src='images/loading.gif'></img></div>"),$("#pv-table-loader").css("top",this.height/2-33+"px"),$("#pv-table-loader").css("left",this.width/2-43+"px")},Filter:function(e,t){this.tiles=e,this.filter=t,this.sortReverse=!1,this.sortReverseEntity=!1,this.sortReverseAttribute=!1,this.sortReverseValue=!1,this.CreateTable(t,this.selectedFacet,this.sortKey,this.sortReverse),this.filtered=!1},Activate:function(){Modernizr.canvas&&(this._super(),Debug.Log("Table View Filtered: "+this.filterEvt.filter.length),$(".pv-toolbarpanel-sort").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-tableview-table").fadeIn(),this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter))},Deactivate:function(){this._super(),$(".pv-tableview-table").fadeOut(),$(".pv-toolbarpanel-sort").fadeOut()},GetButtonImage:function(){return"images/TableView.png"},GetButtonImageSelected:function(){return"images/TableViewSelected.png"},GetViewName:function(){return"Table View"},CellClick:function(e,t){if(Debug.Log("CellClick"),"pv-key"==e){var i=t[0].attributes.getNamedItem("itemid").value
if(null==this.selected||i!=this.selected.facetItem.Id){var l=TileController.GetTileById(i)
$.publish("/PivotViewer/Views/Item/Selected",[{item:l,bkt:0}])}else i==this.selected.facetItem.Id&&$.publish("/PivotViewer/Views/Item/Selected",[{item:null,bkt:0}])}else if("pv-facet"==e){var r
r=null==this.selected?this.filter:[this.selected],""==this.selectedFacet||null==this.selectedFacet?(this.selectedFacet=t[1].textContent.trim(),this.CreateTable(r,this.selectedFacet,this.sortKey)):(this.selectedFacet="",this.CreateTable(r,"")),$.publish("/PivotViewer/Views/Item/Updated",null)}else if("pv-value"==e){var a=t[2].attributes.getNamedItem("value").value
$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:t[1].textContent.trim(),Item:a,MaxRange:a,Values:null}])}},CreateTable:function(e,t,i,l){var r=this,a=$("#pv-table"),s=!1,o=new Array
a.empty()
var c,d
null!=t&&""!=t&&void 0!=t||(s=!0),$(".pv-tableview-table").css("height",this.height-12+"px"),$(".pv-tableview-table").css("width",this.width-415+"px"),c=l?"images/sort-up.png":"images/sort-down.png"
var v="odd-row",p="<table id='pv-table-data' style='color:#484848;'><tr class='pv-tableview-heading'><th id='pv-key' title='Sort on subject name'>Subject"
"pv-key"==i&&(p+=" <img style='position:relative;top:"+d+"' src='"+c+"'></img>"),p+="</th><th id='pv-facet' title='Sort on predicate name'>Predicate","pv-facet"==i&&(p+=" <img style='position:relative;top:"+d+"' src='"+c+"'></img>"),p+="</th><th id='pv-value' title='Sort on object'>Object","pv-value"==i&&(p+=" <img style='position:relative;top:"+d+"' src='"+c+"'></img>"),p+="</th></tr>"
for(var u=0;u<e.length;u++){var n=e[u].facetItem.Name,h=e[u].facetItem.Id
if(s||"Description"==t){var g
if("pv-key"==i?g=n:"pv-facet"==i?g="Description":"pv-value"==i&&(g=e[u].facetItem.Description),e[u].facetItem.Description&&(e[u].facetItem.Href?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' title='Follow the link' src='images/goout.gif'></img></a></a></td><td id='pv-facet' title='Show only this predicate' style='color:#009933;cursor:pointer'>Description</td><td id='pv-value'>"+e[u].facetItem.Description+"</td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"' class='tooltip' title='Toggle item selection'>"+n+"</td><td id='pv-facet' title='Show only this predicate' style='color:#009933;cursor:pointer'>Description</td><td id='pv-value'>"+e[u].facetItem.Description+"</td></tr>"}),v="even-row"),v="odd-row"==v?"even-row":"odd-row",s)for(var f=0;f<e[u].facetItem.Facets.length;f++)for(var m=e[u].facetItem.Facets[f],y=m.Name,b=0;b<m.FacetValues.length;b++){var g,k=m.FacetValues[b].Value,w=m.FacetValues[b].Label
"pv-key"==i?g=n:"pv-facet"==i?g=y:"pv-value"==i&&(g=k),PivotCollection.GetFacetCategoryByName(y).IsFilterVisible?e[u].facetItem.Href?this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet'  title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+" <a href="+k+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet'  title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+"</td></tr>"}):this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection'>"+n+"</td><td id='pv-facet'  title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+" <a href='"+k+"' target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection'>"+n+"</td><td id='pv-facet'  title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+"</td></tr>"}):e[u].facetItem.Href?this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"'><a href='"+k+"' target='_blank'>"+w+"</a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"'>"+w+"</td></tr>"}):this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Select this value'>"+n+"</td><td id='pv-facet' title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"'><a href='"+k+"' target='_blank'>"+w+"</a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Select this value'>"+n+"</td><td id='pv-facet' title='Show only this predicate' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' value='"+k+"'>"+w+"</td></tr>"}),v="odd-row"==v?"even-row":"odd-row"}}else for(m=e[u].facetItem.FacetByName[t],b=0;b<m.FacetValues.length;b++){var g,k=m.FacetValues[b].Value,w=m.FacetValues[b].Label
"pv-key"==i?g=n:"pv-facet"==i?g=t:"pv-value"==i&&(g=k),PivotCollection.GetFacetCategoryByName(t).IsFilterVisible?e[u].facetItem.Href?this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+k+" <a href='"+k+"' target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+"</td></tr>"}):this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection'>"+n+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+" <a href='"+k+"' target='_blank'><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection'>"+n+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"' title='Filter on this value' style='color:#009933;cursor:pointer'>"+w+"</td></tr>"}):e[u].facetItem.Href?this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Click the cell to select this item' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"'><a href='"+k+"' target='_blank'>"+w+"</a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Click the cell to select this item' style='color:#009933;cursor:pointer'>"+n+" <a href="+e[u].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"'>"+w+"</td></tr>"}):this.IsUri(k)?o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection'>"+n+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"'><a href='"+k+"' target='_blank'>"+w+"</a></td></tr>"}):o.push({key:g,value:"<tr class='pv-tableview-"+v+"'><td id='pv-key' itemid='"+h+"'title='Toggle item selection'>"+n+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear predicate selection' style='color:#009933;cursor:pointer'>"+t+"</td><td id='pv-value' value='"+k+"'>"+w+"</td></tr>"}),v="odd-row"==v?"even-row":"odd-row"}}if(0==o.length){if(1==s){var I="There is no data to show about the selected items"
return $(".pv-wrapper").append('<div id="pv-dztable-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+I+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dztable-error","_self")},1e3)}this.CreateTable(e,"",i,l)}else{o.sort(function(e,t){return e.key>t.key?1:e.key<t.key?-1:0}),l&&o.reverse()
for(var u=0;u<o.length;u++)p+=o[u].value
p+="</table>",a.append(p),$("#pv-table-data").colResizable({disable:!0}),$("#pv-table-data").colResizable({disable:!1}),$(".pv-tableview-heading").on("click",function(e){$("#pv-table-loader").show()
var t,i=e.originalEvent.target.id
t=null==r.selected?r.filter:[r.selected],"pv-key"==i?r.sortReverse=r.sortReverseEntity:"pv-facet"==i?r.sortReverse=r.sortReverseAttribute:"pv-value"==i&&(r.sortReverse=r.sortReverseValue),r.sortKey=i,r.CreateTable(t,r.selectedFacet,i),$("#pv-table-loader").fadeOut()}),$(".pv-tableview-odd-row").on("click",function(e){$("#pv-table-loader").show()
var t=e.originalEvent.target.id
r.CellClick(t,e.currentTarget.cells),$("#pv-table-loader").fadeOut()}),$(".pv-tableview-even-row").on("click",function(e){$("#pv-table-loader").show()
var t=e.originalEvent.target.id
r.CellClick(t,e.currentTarget.cells),$("#pv-table-loader").fadeOut()})}},SetSelected:function(e){this._super(e),null==e?this.CreateTable(this.filter,this.selectedFacet):this.CreateTable([e],this.selectedFacet)},IsUri:function(e){if("string"==typeof e){if("http:"==e.substring(0,5))return!0
if("https:"==e.substring(0,6))return!0}return!1}})
