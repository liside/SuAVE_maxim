PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[];this._itemsById=[];this._collageItems=[];this.baseUrl="";this._collageMaxLevel=0;this._tileSize=256;this._format="";this._ratio=1;this.MaxRatio=0;this._dziQueue=[];this._zooming=!1;var n=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(t){n._zooming=t})},setup:function(n){this.baseUrl=n.substring(0,n.lastIndexOf("/"));this._collageUrl=n.substring(n.lastIndexOf("/")+1).replace(".xml","_files");var t=this;$.ajax({type:"GET",url:n,dataType:"xml",success:function(n){var c=$(n).find("Collection"),r,e,o,l;if(t._tileSize=$(c).attr("TileSize"),t._format=$(c).attr("Format"),t._collageMaxLevel=$(c).attr("MaxLevel"),r=$(n).find("I"),r.length==0){$(".pv-loading").remove();e="No items in the DeepZoom Collection<br><br>";e+="URL        : "+this.url+"<br>";e+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+e+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3);return}if(o=$(r[0]).find("Size"),o.length>0)for(t.MaxWidth=parseInt(o.attr("Width")),t.Height=parseInt(o.attr("Height")),t.MaxRatio=t.Height/t.MaxWidth,i=0;i<r.length;i++){itemSize=$(r[i]).find("Size");var u=parseInt(itemSize.attr("Width")),s=parseInt(itemSize.attr("Height")),v=u>s?u:s,y=Math.ceil(Math.log(v)/Math.log(2));t._ratio=s/u;var f=$(r[i]).attr("Source"),a=$(r[i]).attr("Id"),p=$(r[i]).attr("N"),w=f.substring(f.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),h=f.substring(0,f.lastIndexOf("/"));h.length>0&&(h=h+"/");u>t.MaxWidth&&(t.MaxWidth=u);t._ratio>t.MaxRatio&&(t.MaxRatio=t._ratio);l=new PivotViewer.Views.DeepZoomItem(a,w,p,h,t._ratio,u,s,y,t.baseUrl,f);t._items.push(l);t._itemsById[a]=l}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(n,t,i){$(".pv-loading").remove();var r="Error loading from DeepZoom Cache<br><br>";r+="URL        : "+this.url+"<br>";r+="Status : "+n.status+" "+i+"<br>";r+="Details    : "+n.responseText+"<br>";r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+r+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},getImages:function(n,t,i){var r=Math.ceil(Math.log(t>i?t:i)/Math.log(2));return(r==Infinity||r==-Infinity)&&(r=0),this.getImagesAtLevel(n,r)},getImagesAtLevel:function(n,t){var i,u,r,f;t=t<=0?6:t;i=this._itemsById[n];t=t>i.MaxLevel?i.MaxLevel:t;var e=i.DZN.toString(2),o="",s="";for(u=0;u<e.length;u++)u%2==0?o+=e[u]:s+=e[u];if(dzCol=parseInt(o,2),dzRow=parseInt(s,2),i.Levels!=undefined&&i.Levels.length!=0||this._zooming)i.Levels.length<t&&!this._zooming&&(f=this.getImageList(n,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/"+t+"/",t),i.Levels.splice(t,0,new PivotViewer.Views.ImageLevel(f)));else return f=this.getImageList(n,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/6/",6),i.Levels.push(new PivotViewer.Views.ImageLevel(f)),null;for(r=t;r>-1;r--){if(i.Levels[r]!=undefined&&i.Levels[r].IsLoaded())return i.Levels[r].getImages();r!=t||i.Levels[r]!=undefined||this._zooming||(f=this.getImageList(n,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/"+r+"/",r),i.Levels.splice(r,0,new PivotViewer.Views.ImageLevel(f)))}return null},getImageList:function(n,t,i){for(var u,e=[],o=this._tileSize,r=this._itemsById[n],s=r.Height,h=r.MaxLevel,c=r.Format==null?this._format:r.Format,l=Math.ceil(s/r.Ratio/Math.pow(2,h-i)),a=Math.ceil(s/Math.pow(2,h-i)),v=Math.ceil(l/o),y=Math.ceil(a/o),f=0;f<v;f++)for(u=0;u<y;u++)e.push(t+f+"_"+u+"."+c);return e},getWidthForImage:function(n,t){return Math.floor(t/this._itemsById[n].Ratio)},getMaxLevel:function(n){return this._itemsById[n].MaxLevel},getHeight:function(n){return this._itemsById[n].Height},getOverlap:function(n){return this._itemsById[n].Overlap},getRatio:function(n){return this._itemsById[n].Ratio}});PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(n,t,i,r,u,f,e,o,s,h){this.ItemId=n;this.DZId=t;this.DZN=parseInt(i);this.BasePath=r;this.Levels=[];this.Ratio=u;this.Width=f;this.Height=e;this.MaxLevel=o;var l=this,c=TileController._imageController._dziQueue[t];c==undefined?(c=TileController._imageController._dziQueue[t]=[],c.push(this),$.ajax({type:"GET",url:s+"/"+h,dataType:"xml",success:function(n){var r=$(n).find("Image"),t,i;if(r.length!=0){var u=$(r[0]),f=u.attr("Overlap"),e=u.attr("Format");for(t=0;t<c.length;t++)i=c[t],i.Overlap=f,i.Format=e}},error:function(){l.Overlap=0}})):c.push(this)}});PivotViewer.Views.ImageLevel=Object.subClass({init:function(n){var r,t,i;for(this._images=[],this._loaded=!1,r=this,t=0;t<n.length;t++)i=new Image,i.src=n[t],i.onload=function(){r._loaded=!0},this._images.push(i)},getImages:function(){return this._images},IsLoaded:function(){return this._loaded}});
