//
//  HTML5 PivotViewer
//
//  Collection loader interface - used so that different types of data sources can be used
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012-2014 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
///
/// Deep Zoom Image Getter
/// Retrieves and caches images
///
//                     for (var i = 0; i < dziQueue.length; i++) {
//                         var item = dziQueue[i];
// //                        item.Overlap = overlap; item.Format = format;
//                         item.Overlap = 1; item.Format = null;
//                     }
PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._itemsById=[],this._collageItems=[],this.baseUrl="",this._collageMaxLevel=0,this._collageItemOverlap=1,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=0,this._dziQueue=[],this._zooming=!1
var e=this
$.subscribe("/PivotViewer/ImageController/Zoom",function(t){e._zooming=t})},setup:function(e){this.baseUrl=e.substring(0,e.lastIndexOf("/")),this._collageUrl=e.substring(e.lastIndexOf("/")+1).replace(".xml","_files")
var t=this
$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var a=$(e).find("Collection")
t._tileSize=$(a).attr("TileSize"),t._format=$(a).attr("Format"),t._collageMaxLevel=$(a).attr("MaxLevel")
var o=$(a).attr("ItemOverlap")
t._collageItemOverlap=void 0!=o&&null!=o?o:1
var r=$(a).attr("ImageSrc")
void 0!=r&&null!=r&&(t.baseUrl=r)
var s=$(e).find("I")
if(0==s.length){$(".pv-loading").remove()
var l="No items in the DeepZoom Collection<br><br>"
return l+="URL        : "+this.url+"<br>",l+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+l+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}var n=$(s[0]).find("Size")
if(n.length>0)for(t.MaxWidth=parseInt(n.attr("Width")),t.Height=parseInt(n.attr("Height")),t.MaxRatio=0,i=0;i<s.length;i++){itemSize=$(s[i]).find("Size")
var h=parseInt(itemSize.attr("Width")),v=parseInt(itemSize.attr("Height")),d=h>v?h:v,g=Math.ceil(Math.log(d)/Math.log(2))
t._ratio=v/h
var m=$(s[i]).attr("Source"),u=$(s[i]).attr("Id"),p=$(s[i]).attr("N"),c=m.substring(m.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),I=m.substring(0,m.lastIndexOf("/"))
I.length>0&&(I+="/"),h>t.MaxWidth&&(t.MaxWidth=h),t.MaxRatio+=t._ratio
var f=new PivotViewer.Views.DeepZoomItem(u,c,p,I,t._ratio,h,v,g,t.baseUrl,m)
t._items.push(f),t._itemsById[u]=f}t.MaxRatio/=s.length,console.debug("ratio:",t.MaxRatio),$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(e,t,i){$(".pv-loading").remove()
var a="Error loading from DeepZoom Cache<br><br>"
a+="URL        : "+this.url+"<br>",a+="Status : "+e.status+" "+i+"<br>",a+="Details    : "+e.responseText+"<br>",a+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+a+"</p></div></div>"),setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},getImages:function(e,t,i){var a=Math.ceil(Math.log(t>i?t:i)/Math.log(2))
return a!=1/0&&a!=-(1/0)||(a=0),this.getImagesAtLevel(e,a)},getImagesAtLevel:function(e,t){t=t<=0?6:t
var i=this._itemsById[e]
t=t>i.MaxLevel?i.MaxLevel:t
for(var a=i.DZN.toString(2),o="",r="",s=0;s<a.length;s++)s%2==0?o+=a[s]:r+=a[s]
if(dzCol=parseInt(o,2),dzRow=parseInt(r,2),!(void 0!=i.Levels&&0!=i.Levels.length||this._zooming)){var l=this.getImageList(e,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/6/",6)
return i.Levels.push(new PivotViewer.Views.ImageLevel(l)),null}if(i.Levels.length<t&&!this._zooming){var l=this.getImageList(e,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/"+t+"/",t)
i.Levels.splice(t,0,new PivotViewer.Views.ImageLevel(l))}for(var n=t;n>-1;n--){if(void 0!=i.Levels[n]&&i.Levels[n].IsLoaded())return i.Levels[n].getImages()
if(n==t&&void 0==i.Levels[n]&&!this._zooming){var l=this.getImageList(e,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/"+n+"/",n)
i.Levels[n]=new PivotViewer.Views.ImageLevel(l)
break}}return null},getImageList:function(e,t,i){for(var a=[],o=this._tileSize,r=this._itemsById[e],s=r.Height,l=r.MaxLevel,n=Math.ceil(s/r.Ratio/Math.pow(2,l-i)),h=Math.ceil(s/Math.pow(2,l-i)),v=Math.ceil(n/o),d=Math.ceil(h/o),g=0;g<v;g++)for(var m=0;m<d;m++)a.push(t+g+"_"+m+"."+this._format)
return a},getWidthForImage:function(e,t){return Math.floor(t/this._itemsById[e].Ratio)},getMaxLevel:function(e){return this._itemsById[e].MaxLevel},getHeight:function(e){return this._itemsById[e].Height},getWidth:function(e){return this._itemsById[e].Width},getOverlap:function(e){return this._collageItemOverlap},getRatio:function(e){return this._itemsById[e].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(e,t,i,a,o,r,s,l,n,h){this.ItemId=e,this.DZId=t,this.DZN=parseInt(i),this.BasePath=a,this.Levels=[],this.Ratio=o,this.Width=r,this.Height=s,this.MaxLevel=l
var v=TileController._imageController._dziQueue[t]
void 0==v?(v=TileController._imageController._dziQueue[t]=[],v.push(this)):v.push(this)}}),PivotViewer.Views.ImageLevel=Object.subClass({init:function(e){this._images=[],this._loaded=!1
for(var t=this,i=0;i<e.length;i++){var a=new Image
a.src=e[i],a.onload=function(){t._loaded=!0},this._images.push(a)}},getImages:function(){return this._images},IsLoaded:function(){return this._loaded}})
